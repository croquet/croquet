/**
 * Copyright Croquet Corporation 2020
 * Bundle of @croquet/croquet
 * Generated: 2020-08-25
 * Version: 0.3.3-3+main.4c16c09d0305bfdbc357793a1d3b492e9527d9bd
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/slicedToArray"),t=require("@babel/runtime/helpers/classCallCheck"),n=require("@babel/runtime/helpers/createClass"),r=require("@babel/runtime/helpers/toConsumableArray"),o=require("@babel/runtime/helpers/typeof"),i=require("@babel/runtime/helpers/defineProperty"),a=require("@babel/runtime/regenerator"),s=require("@babel/runtime/helpers/asyncToGenerator"),u=require("fast-json-stable-stringify"),c=require("toastify-js"),l=require("seedrandom/seedrandom"),f=require("@babel/runtime/helpers/get"),h=require("@babel/runtime/helpers/inherits"),d=require("@babel/runtime/helpers/possibleConstructorReturn"),p=require("@babel/runtime/helpers/getPrototypeOf"),v=require("fastpriorityqueue"),y=require("@babel/runtime/helpers/toArray"),m=require("@babel/runtime/helpers/construct"),g=require("crypto-js"),w=require("pako");function b(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var k=b(e),S=b(t),x=b(n),E=b(r),C=b(o),O=b(i),M=b(a),_=b(s),A=b(u),T=b(c),I=b(l),q=b(f),j=b(h),P=b(d),N=b(p),D=b(v),L=b(y),R=b(m),B=b(g),U=b(w);const F="production",H="0.3.3-3+main.4c16c09d0305bfdbc357793a1d3b492e9527d9bd";if(void 0===window.TextEncoder){window.TextEncoder=function(){},TextEncoder.prototype.encode=function(e){for(var t=e.length,n=-1,r="undefined"==typeof Uint8Array?new Array(1.5*t):new Uint8Array(3*t),o=0,i=0,a=0;a!==t;){if(o=e.charCodeAt(a),a+=1,o>=55296&&o<=56319){if(a===t){r[n+=1]=239,r[n+=1]=191,r[n+=1]=189;break}if(!((i=e.charCodeAt(a))>=56320&&i<=57343)){r[n+=1]=239,r[n+=1]=191,r[n+=1]=189;continue}if(a+=1,(o=1024*(o-55296)+i-56320+65536)>65535){r[n+=1]=240|o>>>18,r[n+=1]=128|o>>>12&63,r[n+=1]=128|o>>>6&63,r[n+=1]=128|63&o;continue}}o<=127?r[n+=1]=0|o:o<=2047?(r[n+=1]=192|o>>>6,r[n+=1]=128|63&o):(r[n+=1]=224|o>>>12,r[n+=1]=128|o>>>6&63,r[n+=1]=128|63&o)}return"undefined"!=typeof Uint8Array?r.subarray(0,n+1):(r.length=n+1,r)},TextEncoder.prototype.toString=function(){return"[object TextEncoder]"};try{Object.defineProperty(TextEncoder.prototype,"encoding",{get:function(){if(TextEncoder.prototype.isPrototypeOf(this))return"utf-8";throw TypeError("Illegal invocation")}})}catch(e){TextEncoder.prototype.encoding="utf-8"}"undefined"!=typeof Symbol&&(TextEncoder.prototype[Symbol.toStringTag]="TextEncoder")}function $(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return J(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return J(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function J(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function z(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return W(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return W(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}"object"===("undefined"==typeof module?"undefined":C.default(module))&&module.bundle&&module.bundle.modules&&module.bundle.cache&&function(){for(var e=module.bundle,t={},n={},r={},o=0,i=Object.entries(e.modules);o<i.length;o++){var a=k.default(i[o],2),s=a[0],u=a[1],c=""+e.modules[s][0],l=n[c];l?r[s]=l:n[c]=s;for(var f=0,h=Object.entries(u[1]);f<h.length;f++){var d=k.default(h[f],2),p=d[0],v=d[1];(t[v]||(t[v]=new Set)).add(p)}}for(var y=function(e){return t[e]?"".concat(E.default(t[e]).sort().join('" and "')):"top-level"},m={},g=[],w=0,b=Object.entries(e.modules);w<b.length;w++)for(var S=k.default(b[w],2),x=S[0],C=S[1],O=0,M=Object.entries(C[1]);O<M.length;O++){var _=k.default(M[O],2),A=_[0],T=_[1],I=r[T];I&&(e.cache[T]?m[I]=T:(C[1][A]=I,delete e.modules[T],g.push('"'.concat(A,'" in "').concat(y(x),'" (').concat(x,")"))))}for(var q=0,j=Object.entries(e.modules);q<j.length;q++)for(var P=k.default(j[q],2),N=P[0],D=P[1],L=0,R=Object.entries(D[1]);L<R.length;L++){var B=k.default(R[L],2),U=B[0],F=B[1],H=m[F];H&&(e.cache[F]?console.warn('Could not deduplicate import "'.concat(U,'" in "').concat(y(N),'" (to fix, import "').concat(y(module.id),'" earlier)')):(D[1][U]=H,delete e.modules[F],g.push('"'.concat(U,'" in "').concat(y(N),'" (').concat(N,")"))))}var J,z=$(g.sort());try{for(z.s();!(J=z.n()).done;){var W=J.value;console.log("Deduplicated import",W)}}catch(e){z.e(e)}finally{z.f()}}();var V=window.location.hostname.endsWith("croquet.studio"),G="",K="";function Q(e,t){if(t){var n,r=z(t.split("&"));try{for(r.s();!(n=r.n()).done;){var o=n.value.split("="),i=o[0],a=!0;if(o.length>1&&(a=decodeURIComponent(o.slice(1).join("="))).match(/^(true|false|null|[0-9.]*|["[{].*)$/))try{a=JSON.parse(a)}catch(e){"["===a[0]&&(a=a.slice(1,-1).split(","))}e[i]=a}}catch(e){r.e(e)}finally{r.f()}}}var Y=new(function(){function e(){S.default(this,e),this.getSession(),Q(this,window.location.search.slice(1)),Q(this,V?window.location.hash.slice(1):K),window.location.pathname.indexOf("/ar.html")>=0&&(this.ar=!0)}return x.default(e,[{key:"has",value:function(e,t,n){"boolean"!=typeof n&&(n=this.isHost(n));var r=this[e];if("string"!=typeof r)return n;var o=r.split(",");return!0===n&&(t="no".concat(t)),t.endsWith("s")&&(t=t.slice(0,-1)),o.includes(t)||o.includes("".concat(t,"s"))?!n:n}},{key:"getSession",value:function(){if(V){var e=window.location.pathname.match(/^\/([^/]+)\/(.*)$/);if(e)return G=e[1],e[2]}else{var t=window.location.hash.match(/^#([^&]+)&?(.*)$/);if(t)return t[1].includes("=")?(K="".concat(t[1],"&").concat(t[2]),""):(K=t[2],t[1])}return"string"==typeof this.session?(K=window.location.hash.slice(1),this.session):""}},{key:"setSession",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];null==V&&this.getSession();var n=window.location,r=n.search,o=n.hash,i=V?"/".concat(G,"/").concat(e).concat(r).concat(o):"#".concat(e).concat(K?"&"+K:"");t?window.history.replaceState({},"",i):window.history.pushState({},"",i)}},{key:"isHost",value:function(e){var t=window.location.hostname;return t===e||"localhost"===e&&(!!t.endsWith(".ngrok.io")||["127.0.0.1","[::1]"].includes(t))}},{key:"isLocalhost",value:function(){return this.isHost("localhost")}}]),e}());function X(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r={};try{r=JSON.parse(localStorage.croquetUser||"{}")}catch(e){}return e in r?r[e]:n?(r[e]=n(),r[e]!==t&&(localStorage.croquetUser=JSON.stringify(r)),r[e]):t}function Z(){return ee.apply(this,arguments)}function ee(){return(ee=_.default(M.default.mark((function e(){return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Y.nologin){e.next=2;break}return e.abrupt("return",!1);case 2:if(!X("name")||Y.user){e.next=4;break}return e.abrupt("return",!0);case 4:return e.abrupt("return",new Promise((function(e){var t=document.createElement("style");t.innerHTML='\n            .overlay {\n                z-index: 1010;\n                position: fixed;\n                left: 0;\n                top: 0;\n                width: 100%;\n                height: 100%;\n                background-color:#333;\n                opacity:0.9;\n                display:flex;\n                align-items:center;\n                justify-content:center\n            }\n            form {\n                background-color: #fff;\n                color: #666;\n                border-radius: 10px;\n                padding: 16px;\n                font-size: 14px;\n            }\n            form dt { margin: 4px 0 }\n            form dd { margin-left: 0 }\n            form input {\n                border: 1px solid #ccc;\n                border-radius: 5px;\n                min-height: 46px;\n                padding: 10px;\n                font-size: 16px;\n                width: 100%;\n                box-shadow: inset 0 1px 2px #666;\n            }\n            form input:invalid { border: 1px solid red; }\n            form input:valid   { border: 1px solid #ccc; }\n            form button {\n                padding: 20px 32px;\n                background-color: #3b5;\n                color: #fff;\n                border-radius: 50px;\n                border-width:0;\n                font-size: 16px;\n                font-weight: 500;\n                width: 100%;\n            }\n            .error {\n                visibility: hidden;\n                width: 250px;\n                background-color: #fcc;\n                color: #900;\n                padding: 5px;\n                border-radius: 6px;\n                border: 1px solid #c99;\n                position: absolute;\n                margin-top: 5px;\n                font-size: 12px;\n            }\n            .error::after {\n                content: " ";\n                position: absolute;\n                bottom: 100%;  /* At the top of message */\n                left: 10px;\n                border-width: 5px;\n                border-style: solid;\n                border-color: transparent transparent #c99 transparent;\n            }\n            .notice {\n                visibility: hidden;\n                width: 270px;\n                height: 70px;\n                background-color: #fff;\n                padding: 5px;\n                position: absolute;\n                margin-top: 5px;\n                font-size: 12px;\n            }\n        ',document.head.appendChild(t);var n=document.createElement("form");n.innerHTML='\n            <dl>\n                <dt><label for="user[name]">Username</label></dt>\n                <dd>\n                    <input type="text" required pattern="^[a-zA-Z0-9_]*$" minlength="2" maxlength="15" name="user[name]" id="user[name]" placeholder="Enter a username" autocomplete="off" spellcheck="false"></input>\n                </dd>\n                <dd class="error"></dd>\n                <dd class="notice"></dd>\n            </dl>\n            <dl>\n                <dt><label for="user[email]">Email</label></dt>\n                <dd>\n                    <input type="email" required id="user[email]" placeholder="you@example.com" autocomplete="off" spellcheck="false"></input>\n                </dd>\n                <dd class="error"></dd>\n            </dl>\n            <dl>\n                <dt><label for="user[password]">Password</label></dt>\n                <dd>\n                    <input type="password" required minlength="8" id="user[password]" placeholder="Create a password" autocomplete="off" spellcheck="false"></input>\n                </dd>\n                <dd class="error"></dd>\n            </dl>\n            <button id="user[create]">Sign up / Log in</button>\n            <div style="margin:16px auto;text-align: center">— OR —</div>\n            <button id="user[guest]" style="background-color: #999">Continue as Croquet Guest</button>\n            <div style="max-width:280px;text-align: center;font-size:11px;margin:4px auto">\n                Continuing from this screen to our website indicates that you agree to our\n                <a href="/terms.html" target="_blank" style="color:#36c;text-decoration:none">terms of service</a>\n                and\n                <a href="/privacy.html" target="_blank" style="color:#36c;text-decoration:none">privacy statement</a>.\n            </div>\n        ';var r=document.createElement("div");r.classList.add("overlay"),r.appendChild(n),document.body.appendChild(r);var o=n.getElementsByTagName("input"),i=k.default(o,3),a=i[0],s=i[1],u=i[2],c=n.getElementsByClassName("error"),l=k.default(c,3),f=l[0],h=l[1],d=l[2],p=n.getElementsByClassName("notice"),v=k.default(p,1)[0],y=n.getElementsByTagName("button"),m=k.default(y,2),g=m[0],w=m[1];"string"==typeof Y.user?a.value=Y.user:X("name")&&(a.value=X("name"));var b=0;a.oninput=function(){clearTimeout(b),b=setTimeout((function(){return O()}),300)},q(!0),a.oninput();var S=0;s.oninput=function(){clearTimeout(S),S=setTimeout((function(){return T()}),300)};var x=0;function E(){n.reset(),document.head.removeChild(t),document.body.removeChild(r)}function C(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:".json";return"".concat(ae(),"/user/").concat(e.toLowerCase(),"/").concat(t).concat(n)}function O(){return A.apply(this,arguments)}function A(){return(A=_.default(M.default.mark((function e(){var t,n,r,o,i,s=arguments;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]&&s[0],f.style.visibility="hidden",t||q(!0),(n=a.value.trim())||t){e.next=6;break}return e.abrupt("return",!1);case 6:if(!a.validity.tooShort&&!a.validity.tooLong){e.next=10;break}return f.innerHTML="Your username must be between ".concat(a.minLength," and ").concat(a.maxLength," characters long."),f.style.visibility="visible",e.abrupt("return",!1);case 10:if(!a.validity.patternMismatch){e.next=14;break}return f.innerHTML="Your username can only contain alphanumeric characters (letters A-Z, numbers 0-9) and underscores.",f.style.visibility="visible",e.abrupt("return",!1);case 14:return e.prev=14,r=b,e.next=18,fetch(C(n,"salt"),{mode:"cors"});case 18:if(o=e.sent,r===b||t){e.next=21;break}return e.abrupt("return",!1);case 21:if(!o.ok){e.next=27;break}return t||q(!1),e.next=25,o.json();case 25:return i=e.sent,e.abrupt("return",{name:n,salt:fe(i.salt)});case 27:e.next=31;break;case 29:e.prev=29,e.t0=e.catch(14);case 31:return e.abrupt("return",{name:n});case 32:case"end":return e.stop()}}),e,null,[[14,29]])})))).apply(this,arguments)}function T(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];h.style.visibility="hidden";var t=s.value.trim();return!(!t&&!e)&&(s.validity.valid?t:(h.innerHTML="Please enter a valid email address.",h.style.visibility="visible",!1))}function I(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];d.style.visibility="hidden";var t=u.value;return!(!t&&!e)&&(u.validity.tooShort?(d.innerHTML="Your password must be at least ".concat(u.minLength," characters long."),d.style.visibility="visible",!1):t)}function q(e){var t=a.value.trim();v.innerHTML="“".concat(t,"” is already registered as a user.<br><br>\n                If this is you, please enter your password below to continue.\n                Otherwise, please pick a different name."),v.style.visibility=e?"hidden":"visible",s.disabled=!e,u.placeholder=t?e?"Create a password for “".concat(t,"”"):"Enter password for “".concat(t,"”"):"Enter a password",g.innerHTML=t?e?"Sign up as “".concat(t,"”"):"Log in as “".concat(t,"”"):"Sign up / Log in"}u.oninput=function(){clearTimeout(x),x=setTimeout((function(){return I()}),300)},g.onclick=function(){var t=_.default(M.default.mark((function t(n){var r,o,i,a,s,u,c,l,f,h,p,v,y;return M.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.preventDefault(),t.next=3,O(!0);case 3:if(r=t.sent,o=r.name,i=r.salt,a=!!i||T(!0),s=I(!0),o&&a&&s){t.next=10;break}return t.abrupt("return");case 10:return(u=i)||(u=crypto.getRandomValues(new Uint8Array(8)),fetch(C(o,"salt"),{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({salt:he(u)})})),t.next=14,window.crypto.subtle.importKey("raw",(new TextEncoder).encode(s),{name:"PBKDF2"},!1,["deriveBits"]);case 14:return c=t.sent,t.next=17,window.crypto.subtle.deriveBits({name:"PBKDF2",salt:u,iterations:5e5,hash:"SHA-256"},c,256);case 17:if(l=t.sent,f=he(l),!i){t.next=40;break}return t.prev=20,t.next=23,fetch(C(o,f),{mode:"cors"});case 23:if((h=t.sent).ok){t.next=26;break}throw Error("wrong password");case 26:return t.next=28,h.json();case 28:p=t.sent,console.log("Logged in as ".concat(p.name," <").concat(p.email,">")),localStorage.croquetUser=JSON.stringify(p),t.next=38;break;case 33:return t.prev=33,t.t0=t.catch(20),d.innerHTML="Wrong password for “".concat(o,"“"),d.style.visibility="visible",t.abrupt("return");case 38:t.next=45;break;case 40:v=crypto.getRandomValues(new Uint8Array(16)),y={name:o,email:a,salt:he(u),secret:he(v)},localStorage.croquetUser=JSON.stringify(y),fetch(C(o,f),{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)}),console.log("Signed up as ".concat(y.name," <").concat(y.email,">"));case 45:E(),e(!0);case 47:case"end":return t.stop()}}),t,null,[[20,33]])})));return function(e){return t.apply(this,arguments)}}(),w.onclick=function(t){t.preventDefault(),delete localStorage.croquetUser,E(),e(!1)}})));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function te(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ne(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?te(Object(n),!0).forEach((function(t){O.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):te(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function re(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return oe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return oe(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ie=window.location.hostname.endsWith("croquet.io")?window.location.host:"croquet.io";function ae(){var e="string"==typeof Y.files?Y.files:"https://".concat(ie,"/files/v1");return e.endsWith("/")?e.slice(0,-1):e}function se(){return module.bundle?module.bundle.modules:[]}function ue(){return Object.keys(se()).filter((function(e){return!e.endsWith("hmr-runtime.js")}))}function ce(e){return se()[e]}function le(e){var t,n,r,o;return t=ce(e)[0],r=(n=""+t).indexOf("{"),o=n.lastIndexOf("}"),n.slice(r+1,o).trim()}function fe(e){return new Uint8Array(atob(e.padEnd(e.length+3&-4,"=").replace(/-/g,"+").replace(/_/g,"/")).split("").map((function(e){return e.charCodeAt(0)})))}function he(e){return btoa(String.fromCharCode.apply(String,E.default(new Uint8Array(e)))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function de(e){return pe.apply(this,arguments)}function pe(){return(pe=_.default(M.default.mark((function e(t){var n;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return","47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU");case 2:return e.next=4,window.crypto.subtle.digest("SHA-256",t);case 4:return n=e.sent,e.abrupt("return",he(n));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ve(){return Y.has("debug","hashing",!1)}window.crypto&&window.crypto.subtle&&"function"==typeof window.crypto.subtle.digest||console.error("ERROR: crypto.subtle.digest() browser API not available. Please access this page via https or localhost.");var ye={},me={was_initialized:!1};function ge(e){return me.was_initialized||function(){var e,t=re(ue());try{for(t.s();!(e=t.n()).done;)for(var n=e.value,r=0,o=Object.entries(ce(n)[1]);r<o.length;r++){var i=k.default(o[r],2),a=i[0],s=i[1],u=me[s]||"",c=a.replace(/^[./]*/,"");c.length>u.length&&(me[s]=c)}}catch(e){t.e(e)}finally{t.f()}me.was_initialized=!0}(),me[e]||e}var we=new TextEncoder;function be(e){return ke.apply(this,arguments)}function ke(){return(ke=_.default(M.default.mark((function e(t){var n,r;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=we.encode(t),e.next=3,de(n);case 3:return r=e.sent,ve()&&(ye[r]={string:t,buffer:n}),e.abrupt("return",r);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Se={};function xe(e){return Ee.apply(this,arguments)}function Ee(){return(Ee=_.default(M.default.mark((function e(t){var n,r;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Se[t]){e.next=2;break}return e.abrupt("return",Se[t]);case 2:return n=le(t).replace(/\s+/g," "),e.next=5,be(n);case 5:return r=e.sent,ve()&&(ye[r].name="Module ".concat(ge(t))),e.abrupt("return",Se[t]=r);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Ce=[];function Oe(e){var t=be(function(e){function t(e){var t=e.indexOf("{"),n=e.lastIndexOf("}"),r=e.slice(0,t).replace(/\s+/g," ").replace(/\s\(/,"("),o=e.slice(t+1,n);return"".concat(r.trim(),"{").concat(o.trim(),"}")}var n=""+e,r=t(n);if(!n.startsWith("class")){var o=e.prototype;r+=Object.getOwnPropertyNames(o).map((function(e){return"".concat(e,":").concat(t(""+o[e]))})).join("")}return r}(e));t.then((function(t){console.log("hashing class ".concat(e.name,": ").concat(t)),ve()&&(ye[t].name="Class ".concat(e.name))})),Ce.push(t)}function Me(e,t,n){return _e.apply(this,arguments)}function _e(){return(_e=_.default(M.default.mark((function e(t,n,r){var o,i,a,s,u,c;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o="production"===F?[]:ue().filter((function(e){var t=e.endsWith("/package.json")||e.endsWith("/ar.js");return t&&console.warn("excluding ".concat(e," from code hash")),!t})).sort(),e.next=4,Promise.all([].concat(E.default(o.map(xe)),Ce));case 4:return i=e.sent,e.next=7,be([r].concat(E.default(i)).join("|"));case 7:return a=e.sent,e.next=10,be([t,A.default(n)].join("|"));case 10:return s=e.sent,e.next=13,be([s,a].join("|"));case 13:return u=e.sent,ve()&&(ye[a].name="All code hashes",ye[s].name="Session name and options",ye[u].name="Session ID",c=[].concat(E.default(i),[a,s,u]).map((function(e){return ne({hash:e},ye[e])})),console.log("Debug Hashing for session ".concat(u),c)),e.abrupt("return",{id:u,sessionHash:s,codeHash:a});case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ae(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Te(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Te(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function Te(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Ie,qe=function(){function e(){S.default(this,e),this.values=[],this.resolves=[]}var t;return x.default(e,[{key:"next",value:(t=_.default(M.default.mark((function e(){var t=this;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.values.length>0)){e.next=2;break}return e.abrupt("return",this.values.shift());case 2:return e.abrupt("return",new Promise((function(e){return t.resolves.push(e)})));case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"put",value:function(e){var t=this.resolves.shift();t?t(e):this.values.push(e)}},{key:"putAll",value:function(e){var t,n=Ae(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.put(r)}}catch(e){n.e(e)}finally{n.f()}}},{key:"peek",value:function(){return this.values[0]}},{key:"nextNonBlocking",value:function(){return this.values.shift()}},{key:"allNonBlocking",value:function(){if(0===this.values.length)return[];var e=this.values;return this.values=[],e}},{key:"size",get:function(){return this.values.length-this.resolves.length}}]),e}();!function(){function e(e){this.mode=n.MODE_8BIT_BYTE,this.data=e,this.parsedData=[];for(var t=0,r=this.data.length;t<r;t++){var o=[],i=this.data.charCodeAt(t);i>65536?(o[0]=240|(1835008&i)>>>18,o[1]=128|(258048&i)>>>12,o[2]=128|(4032&i)>>>6,o[3]=128|63&i):i>2048?(o[0]=224|(61440&i)>>>12,o[1]=128|(4032&i)>>>6,o[2]=128|63&i):i>128?(o[0]=192|(1984&i)>>>6,o[1]=128|63&i):o[0]=i,this.parsedData.push(o)}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function t(e,t){this.typeNumber=e,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}e.prototype={getLength:function(e){return this.parsedData.length},write:function(e){for(var t=0,n=this.parsedData.length;t<n;t++)e.put(this.parsedData[t],8)}},t.prototype={addData:function(t){var n=new e(t);this.dataList.push(n),this.dataCache=null},isDark:function(e,t){if(e<0||this.moduleCount<=e||t<0||this.moduleCount<=t)throw new Error(e+","+t);return this.modules[e][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(e,n){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var o=0;o<this.moduleCount;o++)this.modules[r][o]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(e,n),this.typeNumber>=7&&this.setupTypeNumber(e),null==this.dataCache&&(this.dataCache=t.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,n)},setupPositionProbePattern:function(e,t){for(var n=-1;n<=7;n++)if(!(e+n<=-1||this.moduleCount<=e+n))for(var r=-1;r<=7;r++)t+r<=-1||this.moduleCount<=t+r||(this.modules[e+n][t+r]=0<=n&&n<=6&&(0==r||6==r)||0<=r&&r<=6&&(0==n||6==n)||2<=n&&n<=4&&2<=r&&r<=4)},getBestMaskPattern:function(){for(var e=0,t=0,n=0;n<8;n++){this.makeImpl(!0,n);var r=h.getLostPoint(this);(0==n||e>r)&&(e=r,t=n)}return t},createMovieClip:function(e,t,n){var r=e.createEmptyMovieClip(t,n);this.make();for(var o=0;o<this.modules.length;o++)for(var i=1*o,a=0;a<this.modules[o].length;a++){var s=1*a;this.modules[o][a]&&(r.beginFill(0,100),r.moveTo(s,i),r.lineTo(s+1,i),r.lineTo(s+1,i+1),r.lineTo(s,i+1),r.endFill())}return r},setupTimingPattern:function(){for(var e=8;e<this.moduleCount-8;e++)null==this.modules[e][6]&&(this.modules[e][6]=e%2==0);for(var t=8;t<this.moduleCount-8;t++)null==this.modules[6][t]&&(this.modules[6][t]=t%2==0)},setupPositionAdjustPattern:function(){for(var e=h.getPatternPosition(this.typeNumber),t=0;t<e.length;t++)for(var n=0;n<e.length;n++){var r=e[t],o=e[n];if(null==this.modules[r][o])for(var i=-2;i<=2;i++)for(var a=-2;a<=2;a++)this.modules[r+i][o+a]=-2==i||2==i||-2==a||2==a||0==i&&0==a}},setupTypeNumber:function(e){for(var t=h.getBCHTypeNumber(this.typeNumber),n=0;n<18;n++){var r=!e&&1==(t>>n&1);this.modules[Math.floor(n/3)][n%3+this.moduleCount-8-3]=r}for(n=0;n<18;n++){r=!e&&1==(t>>n&1);this.modules[n%3+this.moduleCount-8-3][Math.floor(n/3)]=r}},setupTypeInfo:function(e,t){for(var n=this.errorCorrectLevel<<3|t,r=h.getBCHTypeInfo(n),o=0;o<15;o++){var i=!e&&1==(r>>o&1);o<6?this.modules[o][8]=i:o<8?this.modules[o+1][8]=i:this.modules[this.moduleCount-15+o][8]=i}for(o=0;o<15;o++){i=!e&&1==(r>>o&1);o<8?this.modules[8][this.moduleCount-o-1]=i:o<9?this.modules[8][15-o-1+1]=i:this.modules[8][15-o-1]=i}this.modules[this.moduleCount-8][8]=!e},mapData:function(e,t){for(var n=-1,r=this.moduleCount-1,o=7,i=0,a=this.moduleCount-1;a>0;a-=2)for(6==a&&a--;;){for(var s=0;s<2;s++)if(null==this.modules[r][a-s]){var u=!1;i<e.length&&(u=1==(e[i]>>>o&1)),h.getMask(t,r,a-s)&&(u=!u),this.modules[r][a-s]=u,-1==--o&&(i++,o=7)}if((r+=n)<0||this.moduleCount<=r){r-=n,n=-n;break}}}},t.PAD0=236,t.PAD1=17,t.createData=function(e,n,r){for(var o=y.getRSBlocks(e,n),i=new m,a=0;a<r.length;a++){var s=r[a];i.put(s.mode,4),i.put(s.getLength(),h.getLengthInBits(s.mode,e)),s.write(i)}var u=0;for(a=0;a<o.length;a++)u+=o[a].dataCount;if(i.getLengthInBits()>8*u)throw new Error("code length overflow. ("+i.getLengthInBits()+">"+8*u+")");for(i.getLengthInBits()+4<=8*u&&i.put(0,4);i.getLengthInBits()%8!=0;)i.putBit(!1);for(;!(i.getLengthInBits()>=8*u||(i.put(t.PAD0,8),i.getLengthInBits()>=8*u));)i.put(t.PAD1,8);return t.createBytes(i,o)},t.createBytes=function(e,t){for(var n=0,r=0,o=0,i=new Array(t.length),a=new Array(t.length),s=0;s<t.length;s++){var u=t[s].dataCount,c=t[s].totalCount-u;r=Math.max(r,u),o=Math.max(o,c),i[s]=new Array(u);for(var l=0;l<i[s].length;l++)i[s][l]=255&e.buffer[l+n];n+=u;var f=h.getErrorCorrectPolynomial(c),d=new v(i[s],f.getLength()-1).mod(f);a[s]=new Array(f.getLength()-1);for(l=0;l<a[s].length;l++){var p=l+d.getLength()-a[s].length;a[s][l]=p>=0?d.get(p):0}}var y=0;for(l=0;l<t.length;l++)y+=t[l].totalCount;var m=new Array(y),g=0;for(l=0;l<r;l++)for(s=0;s<t.length;s++)l<i[s].length&&(m[g++]=i[s][l]);for(l=0;l<o;l++)for(s=0;s<t.length;s++)l<a[s].length&&(m[g++]=a[s][l]);return m};for(var n={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},r={L:1,M:0,Q:3,H:2},o=0,i=1,a=2,s=3,u=4,c=5,l=6,f=7,h={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(e){for(var t=e<<10;h.getBCHDigit(t)-h.getBCHDigit(h.G15)>=0;)t^=h.G15<<h.getBCHDigit(t)-h.getBCHDigit(h.G15);return(e<<10|t)^h.G15_MASK},getBCHTypeNumber:function(e){for(var t=e<<12;h.getBCHDigit(t)-h.getBCHDigit(h.G18)>=0;)t^=h.G18<<h.getBCHDigit(t)-h.getBCHDigit(h.G18);return e<<12|t},getBCHDigit:function(e){for(var t=0;0!=e;)t++,e>>>=1;return t},getPatternPosition:function(e){return h.PATTERN_POSITION_TABLE[e-1]},getMask:function(e,t,n){switch(e){case o:return(t+n)%2==0;case i:return t%2==0;case a:return n%3==0;case s:return(t+n)%3==0;case u:return(Math.floor(t/2)+Math.floor(n/3))%2==0;case c:return t*n%2+t*n%3==0;case l:return(t*n%2+t*n%3)%2==0;case f:return(t*n%3+(t+n)%2)%2==0;default:throw new Error("bad maskPattern:"+e)}},getErrorCorrectPolynomial:function(e){for(var t=new v([1],0),n=0;n<e;n++)t=t.multiply(new v([1,d.gexp(n)],0));return t},getLengthInBits:function(e,t){if(1<=t&&t<10)switch(e){case n.MODE_NUMBER:return 10;case n.MODE_ALPHA_NUM:return 9;case n.MODE_8BIT_BYTE:case n.MODE_KANJI:return 8;default:throw new Error("mode:"+e)}else if(t<27)switch(e){case n.MODE_NUMBER:return 12;case n.MODE_ALPHA_NUM:return 11;case n.MODE_8BIT_BYTE:return 16;case n.MODE_KANJI:return 10;default:throw new Error("mode:"+e)}else{if(!(t<41))throw new Error("type:"+t);switch(e){case n.MODE_NUMBER:return 14;case n.MODE_ALPHA_NUM:return 13;case n.MODE_8BIT_BYTE:return 16;case n.MODE_KANJI:return 12;default:throw new Error("mode:"+e)}}},getLostPoint:function(e){for(var t=e.getModuleCount(),n=0,r=0;r<t;r++)for(var o=0;o<t;o++){for(var i=0,a=e.isDark(r,o),s=-1;s<=1;s++)if(!(r+s<0||t<=r+s))for(var u=-1;u<=1;u++)o+u<0||t<=o+u||0==s&&0==u||a==e.isDark(r+s,o+u)&&i++;i>5&&(n+=3+i-5)}for(r=0;r<t-1;r++)for(o=0;o<t-1;o++){var c=0;e.isDark(r,o)&&c++,e.isDark(r+1,o)&&c++,e.isDark(r,o+1)&&c++,e.isDark(r+1,o+1)&&c++,0!=c&&4!=c||(n+=3)}for(r=0;r<t;r++)for(o=0;o<t-6;o++)e.isDark(r,o)&&!e.isDark(r,o+1)&&e.isDark(r,o+2)&&e.isDark(r,o+3)&&e.isDark(r,o+4)&&!e.isDark(r,o+5)&&e.isDark(r,o+6)&&(n+=40);for(o=0;o<t;o++)for(r=0;r<t-6;r++)e.isDark(r,o)&&!e.isDark(r+1,o)&&e.isDark(r+2,o)&&e.isDark(r+3,o)&&e.isDark(r+4,o)&&!e.isDark(r+5,o)&&e.isDark(r+6,o)&&(n+=40);var l=0;for(o=0;o<t;o++)for(r=0;r<t;r++)e.isDark(r,o)&&l++;return n+=10*(Math.abs(100*l/t/t-50)/5)}},d={glog:function(e){if(e<1)throw new Error("glog("+e+")");return d.LOG_TABLE[e]},gexp:function(e){for(;e<0;)e+=255;for(;e>=256;)e-=255;return d.EXP_TABLE[e]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},p=0;p<8;p++)d.EXP_TABLE[p]=1<<p;for(p=8;p<256;p++)d.EXP_TABLE[p]=d.EXP_TABLE[p-4]^d.EXP_TABLE[p-5]^d.EXP_TABLE[p-6]^d.EXP_TABLE[p-8];for(p=0;p<255;p++)d.LOG_TABLE[d.EXP_TABLE[p]]=p;function v(e,t){if(null==e.length)throw new Error(e.length+"/"+t);for(var n=0;n<e.length&&0==e[n];)n++;this.num=new Array(e.length-n+t);for(var r=0;r<e.length-n;r++)this.num[r]=e[r+n]}function y(e,t){this.totalCount=e,this.dataCount=t}function m(){this.buffer=[],this.length=0}v.prototype={get:function(e){return this.num[e]},getLength:function(){return this.num.length},multiply:function(e){for(var t=new Array(this.getLength()+e.getLength()-1),n=0;n<this.getLength();n++)for(var r=0;r<e.getLength();r++)t[n+r]^=d.gexp(d.glog(this.get(n))+d.glog(e.get(r)));return new v(t,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;for(var t=d.glog(this.get(0))-d.glog(e.get(0)),n=new Array(this.getLength()),r=0;r<this.getLength();r++)n[r]=this.get(r);for(r=0;r<e.getLength();r++)n[r]^=d.gexp(d.glog(e.get(r))+t);return new v(n,0).mod(e)}},y.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],y.getRSBlocks=function(e,t){var n=y.getRsBlockTable(e,t);if(null==n)throw new Error("bad rs block @ typeNumber:"+e+"/errorCorrectLevel:"+t);for(var r=n.length/3,o=[],i=0;i<r;i++)for(var a=n[3*i+0],s=n[3*i+1],u=n[3*i+2],c=0;c<a;c++)o.push(new y(s,u));return o},y.getRsBlockTable=function(e,t){switch(t){case r.L:return y.RS_BLOCK_TABLE[4*(e-1)+0];case r.M:return y.RS_BLOCK_TABLE[4*(e-1)+1];case r.Q:return y.RS_BLOCK_TABLE[4*(e-1)+2];case r.H:return y.RS_BLOCK_TABLE[4*(e-1)+3];default:return}},m.prototype={get:function(e){var t=Math.floor(e/8);return 1==(this.buffer[t]>>>7-e%8&1)},put:function(e,t){for(var n=0;n<t;n++)this.putBit(1==(e>>>t-n-1&1))},getLengthInBits:function(){return this.length},putBit:function(e){var t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),e&&(this.buffer[t]|=128>>>this.length%8),this.length++}};var g=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]],w=function(){var e=function(e,t){this._bIsPainted=!1,this._htOption=t,this._elCanvas=document.createElement("canvas"),this._elCanvas.width=t.width,this._elCanvas.height=t.height,e.appendChild(this._elCanvas),this._el=e,this._oContext=this._elCanvas.getContext("2d"),this._bIsPainted=!1,this._bSupportDataURI=null};return e.prototype.draw=function(e){var t=this._oContext,n=this._htOption,r=e.getModuleCount(),o=n.width/r,i=n.height/r,a=Math.round(o),s=Math.round(i);this.clear();for(var u=0;u<r;u++)for(var c=0;c<r;c++){var l=e.isDark(u,c),f=c*o,h=u*i;t.strokeStyle=l?n.colorDark:n.colorLight,t.lineWidth=1,t.fillStyle=l?n.colorDark:n.colorLight,t.fillRect(f,h,o,i),t.strokeRect(Math.floor(f)+.5,Math.floor(h)+.5,a,s),t.strokeRect(Math.ceil(f)-.5,Math.ceil(h)-.5,a,s)}this._bIsPainted=!0},e.prototype.isPainted=function(){return this._bIsPainted},e.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},e.prototype.round=function(e){return e?Math.floor(1e3*e)/1e3:e},e}();function b(e,t){for(var n=1,o=function(e){var t=encodeURI(e).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return t.length+(t.length!=e?3:0)}(e),i=0,a=g.length;i<=a;i++){var s=0;switch(t){case r.L:s=g[i][0];break;case r.M:s=g[i][1];break;case r.Q:s=g[i][2];break;case r.H:s=g[i][3]}if(o<=s)break;n++}if(n>g.length)throw new Error("Too long data");return n}(Ie=function(e,t){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:r.H},"string"==typeof t&&(t={text:t}),t)for(var n in t)this._htOption[n]=t[n];"string"==typeof e&&(e=document.getElementById(e)),this._htOption.useSVG&&(w=svgDrawer),this._el=e,this._oQRCode=null,this._oDrawing=new w(this._el,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)}).prototype.makeCode=function(e){this._oQRCode=new t(b(e,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(e),this._oQRCode.make(),this._oDrawing.draw(this._oQRCode)},Ie.prototype.clear=function(){this._oDrawing.clear()},Ie.prototype.getCanvas=function(){for(var e=0;e<this._el.children.length;e++){var t=this._el.children[e];if("CANVAS"===t.tagName)return t}return null},Ie.CorrectLevel=r}();var je=Ie;function Pe(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ne(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ne(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function Ne(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var De=Date.now();"undefined"==typeof performance&&(window.performance={now:function(){return Date.now()-De}});var Le,Re,Be=["simulate","update","render","snapshot"],Ue={total:"black",update:"blue",render:"magenta",simulate:"yellow",snapshot:"green",backlog:"red",network:"lightgray"},Fe=null,He=null,$e=null,Je=0,ze=null,We=null;function Ve(e){for(Fe=e;e.firstChild;)e.removeChild(e.firstChild);e.style.background="#faf0dc",ze=document.createElement("canvas"),We=ze.getContext("2d"),ze.id="text_stats",ze.width=Math.min(125,window.innerWidth),ze.height=36,ze.style.width=ze.width,ze.style.height=ze.height,We.font="9.5pt sans-serif",e.appendChild(ze),e.title=Object.entries(Ue).map((function(e){var t=k.default(e,2),n=t[0],r=t[1];return"".concat(r,": ").concat(n)})).join("\n"),(He=document.createElement("canvas")).width=Math.min(125,window.innerWidth),He.height=125,He.style.width="100%";var t=document.createElement("div");t.id="innerDiv",e.appendChild(t),t.appendChild(He),$e=He.getContext("2d")}var Ge=[],Ke=0,Qe=!1,Ye=tt(0),Xe=1e3/60;function Ze(e){return 20*(1-e/Xe)+60}function et(e){Le=function(e){var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.style.width="100%",t.style.position="absolute",t.style.left="0px",Fe.querySelector("#innerDiv").appendChild(t),t}(e),(Re=Le.getContext("2d")).strokeStyle="rgba(255, 255, 255, 0.5)";for(var t=0;t<60;t+=Xe){var n=Ze(t);Re.moveTo(0,n),Re.lineTo(Le.width,n),Re.stroke()}}function tt(e){return{start:e,total:0,items:{},users:0,backlog:0,network:0,latency:0,activity:1e3,connected:Qe}}function nt(e){Ye.total=e-Ye.start;var t=Math.min(120,window.innerWidth);if(Ge.length>=t&&Ge.splice(0,Ge.length-t+1),Ge.push(Ye),!(Ge.length<=1)&&Fe&&0!==Fe.offsetHeight){var n=Ge.slice(1).filter((function(e){return e.total})),r=n.map((function(e){return e.total})).reduce((function(e,t){return e+t}),0)/n.length;Math.max.apply(Math,E.default(n.map((function(e){return Math.max(e.backlog,e.network)}))));Ke=1e3,function(e){We.globalCompositeOperation="copy",We.fillStyle="rgb(255, 255, 255, 0)",We.fillRect(0,0,ze.width,ze.height),We.fillStyle="rgb(0, 0, 0, 1)",We.globalCompositeOperation="source-over";var t="".concat(Ye.users," users, ").concat(Math.round(1e3/e)," fps,");We.fillText(t,2,15),t=Ye.backlog<100&&Ye.activity<1e3?"latency: ".concat(Ye.latency," ms"):"backlog: ".concat(Ye.backlog<100?"0.0":(Ye.backlog/1e3).toFixed(1)," s"),We.fillText(t,2,33)}(r),Le||et(He),Je===He.width?($e.globalCompositeOperation="copy",$e.drawImage(He,1,0,He.width-1,He.height,0,0,He.width-1,He.height),$e.globalCompositeOperation="source-over",$e.fillStyle="transparent",$e.fillRect(He.width-1,0,1,He.height)):Je++;var o=function(e){return Ze(e/Ke*-2*Xe)+5},i=Ge[Ge.length-1],a=Je-.5,s=Ze(0);$e.beginPath(),$e.moveTo(a,s),$e.lineTo(a,Ze(i.total)),$e.strokeStyle=Ue[i.connected?"total":"network"],$e.stroke(),$e.beginPath(),$e.moveTo(a,s),s=Ze(i.total);var u,c=0,l=Pe(Be);try{for(l.s();!(u=l.n()).done;){var f=u.value;i.items[f]&&(s=Ze(c+=i.items[f]),$e.lineTo(a,s),$e.strokeStyle=Ue[f],$e.stroke(),$e.beginPath(),$e.moveTo(a,s))}}catch(e){l.e(e)}finally{l.f()}i.network&&($e.beginPath(),$e.moveTo(a,o(0)),$e.lineTo(a,o(i.network)),$e.strokeStyle=Ue.network,$e.stroke())}}var rt=[],ot={animationFrame:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};nt(e),Ye=tt(e);for(var n=0,r=Object.entries(t);n<r.length;n++){var o=k.default(r[n],2),i=o[0],a=o[1];this[i](a)}},begin:function(e){var t=performance.now();Ye.items[e]=(Ye.items[e]||0)-t;var n=rt[rt.length-1];return n&&(Ye.items[n]+=t),rt.push(e),t},end:function(e){var t=performance.now();if(Ye.items[e]+=t,rt.pop()!==e)throw Error("Unmatched stats calls for "+e);var n=rt[rt.length-1];return n&&(Ye.items[n]-=t),t},backlog:function(e){Ye.backlog=Math.max(e,Ye.backlog)},network:function(e){Ye.network=e},starvation:function(e){Ye.network=e},latency:function(e){Ye.latency=e},activity:function(e){Ye.activity=e},users:function(e){Ye.users=e},connected:function(e){var t=Qe;Ye.connected=Qe=e,t&&!Qe&&Le&&(Le.remove(),Re=null)}};function it(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function at(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?it(Object(n),!0).forEach((function(t){O.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):it(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var st,ut,ct,lt="ontouchstart"in document.documentElement,ft=lt?20:12,ht=lt?0:15;st="\n        #croquet_dock { position: absolute; z-index: 2; border: 3px solid white; bottom: 6px; left: 6px; width: 84px; height: 36px; box-sizing: border-box; background: white; opacity: 0.4; transition: all ".concat(.3,"s ease; }\n        #croquet_dock.active { opacity: 0.95; border-radius: 12px; }\n        #croquet_dock_bar { position: absolute; border: 3px solid white; width: 100%; height: 30px; box-sizing: border-box; background: white; }\n\n        #croquet_badge { position: absolute; width: 72px; height: 24px; top: 50%; transform: translate(0px, -50%); cursor: none; }\n        #croquet_dock.active #croquet_badge { left: 2%; }\n\n        .croquet_dock_button { position: absolute; width: ").concat(ft,"%; height: 90%; top: 50%; transform: translate(0px, -50%); border-radius: 20%; }\n        .croquet_dock_button:focus { outline: 0; }\n        .croquet_dock_button canvas { position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; }\n        #croquet_dock:not(.active) .croquet_dock_button { display: none; }\n        #croquet_dock_left { right: ").concat(2+ht+ft+2,"% }\n        #croquet_dock_right { right: ").concat(2+ht,"%; }\n        #croquet_dock_pin { right: ").concat(2,"%; }\n        #croquet_dock_pin.pinned { background: #cce6ff; }\n\n        #croquet_dock_content { position: absolute; left: ").concat(2,"px; top: ").concat(2,"px; right: ").concat(2,"px; bottom: ").concat(2,"px; background: white; overflow: hidden; }\n        #croquet_dock:not(.active) #croquet_dock_content { display: none; }\n        #croquet_dock:not(.active) #croquet_dock_content div { display: none; }\n\n        #croquet_qrcode { position: absolute; border: 6px solid white; width: 100%; height: 100%;box-sizing: border-box; cursor: crosshair; }\n        #croquet_qrcode:not(.active) { display: none; }\n        #croquet_qrcode canvas { image-rendering: pixelated; }\n\n        #croquet_stats { position: absolute; width: 70%; height: 90%; left: 15%; top: 5%; opacity: 0.8; font-family: sans-serif; }\n        #croquet_stats:not(.active) { display: none; }\n\n        #croquet_spinnerOverlay {\n            z-index: 1000;\n            position: fixed;\n            left: 0;\n            top: 0;\n            width: 100%;\n            height: 100%;\n            background-color:#333;\n            opacity:0.9;\n            display:flex;\n            align-items:center;\n            justify-content:center;\n            transition: opacity 1.0s ease-out;\n        }\n        /* https://github.com/lukehaas/css-loaders */\n        @keyframes dots {\n            0%, 80%, 100% { box-shadow: 0 2.5em 0 -1.3em; }\n            40% { box-shadow: 0 2.5em 0 0; }\n        }\n        #croquet_loader,\n        #croquet_loader:before,\n        #croquet_loader:after {\n          border-radius: 50%;\n          width: 2.5em;\n          height: 2.5em;\n          animation: dots 1.8s infinite ease-in-out;\n        }\n        #croquet_loader {\n          color: #fff;\n          font-size: 10px;\n          margin: 80px auto;\n          position: relative;\n          text-indent: -9999em;\n          animation-delay: -0.16s;\n        }\n        #croquet_loader:before,\n        #croquet_loader:after {\n          content: '';\n          position: absolute;\n          top: 0;\n        }\n        #croquet_loader:before { left: -3.5em; animation-delay: -0.32s; }\n        #croquet_loader:after { left: 3.5em; }\n"),(ut=document.createElement("style")).innerHTML=st,document.head.insertBefore(ut,document.head.getElementsByTagName("style")[0]),(ct=document.createElement("style")).innerHTML="/*!\n        * Toastify js 1.5.0\n        * https://github.com/apvarun/toastify-js\n        * @license MIT licensed\n        *\n        * Copyright (C) 2018 Varun A P\n        */\n        .toastify {\n            padding: 12px 20px;\n            color: #ffffff;\n            display: inline-block;\n            box-shadow: 0 3px 6px -1px rgba(0, 0, 0, 0.12), 0 10px 36px -4px rgba(77, 96, 232, 0.3);\n            background: -webkit-linear-gradient(315deg, #73a5ff, #5477f5);\n            background: linear-gradient(135deg, #73a5ff, #5477f5);\n            position: fixed;\n            opacity: 0;\n            transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);\n            border-radius: 2px;\n            cursor: pointer;\n            text-decoration: none;\n            max-width: calc(50% - 20px);\n            z-index: 2147483647;\n        }\n        .toastify.on {\n            opacity: 1;\n        }\n        .toast-close {\n            opacity: 0.4;\n            padding: 0 5px;\n        }\n        .toastify-right {\n            right: 15px;\n        }\n        .toastify-left {\n            left: 15px;\n        }\n        .toastify-top {\n            top: -150px;\n        }\n        .toastify-bottom {\n            bottom: -150px;\n        }\n        .toastify-rounded {\n            border-radius: 25px;\n        }\n        .toastify-avatar {\n            width: 1.5em;\n            height: 1.5em;\n            margin: 0 5px;\n            border-radius: 2px;\n        }\n        @media only screen and (max-width: 360px) {\n            .toastify-right, .toastify-left {\n                margin-left: auto;\n                margin-right: auto;\n                left: 0;\n                right: 0;\n                max-width: fit-content;\n            }\n        }\n\n        .toastify { font-family: sans-serif; border-radius: 8px; }\n",document.head.insertBefore(ct,document.head.getElementsByTagName("style")[0]);var dt,pt=new Set;function vt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e&&Tt.showMessage(e,at(at({},t),{},{level:"error"}))}function yt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e&&Tt.showMessage(e,at(at({},t),{},{level:"warning"}))}function mt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e&&Tt.showMessage(e,at(at({},t),{},{level:"status"}))}function gt(e,t){console.error("Error during ".concat(e),t);var n=(t.stack||"").split("\n").filter((function(e){return!e.match(/croquet-.*\.min.js/)})).join("\n");Tt.showMessage("<b>Error during ".concat(e,": ").concat(t.message,"</b>\n\n").concat(n).replace(/\n/g,"<br>"),{level:"error",duration:1e4,stopOnFocus:!0})}function wt(e,t){var n=Tt.root;if(!1===n)return null;var r,o=at({text:e,duration:3e3,gravity:"bottom",position:"right",backgroundColor:"linear-gradient(to right, #00b09b, #96c93d)",stopOnFocus:!0},t);return n instanceof Element&&n!==document.body?(r=n.id)||(n.id=r="_croquetToastParent"):"string"==typeof n&&(r=n),r&&(o.selector=r),T.default(o).showToast()}try{if((dt=window.localStorage)["croquet-debug-persist-allowed"]="true","true"!==dt["croquet-debug-persist-allowed"])throw Error("localStorage not persisted");delete dt["croquet-debug-persist-allowed"]}catch(e){console.warn("localStorage not allowed"),dt={}}var bt,kt,St={get pinned(){return"true"===dt["croquet-debug-ui-pinned"]},set pinned(e){dt["croquet-debug-ui-pinned"]=!!e},get activePage(){return dt["croquet-debug-ui-activePage"]},set activePage(e){dt["croquet-debug-ui-activePage"]=e}},xt=function(e){e.preventDefault(),e.stopPropagation()};function Et(e,t,n){var r=document.createElement("canvas"),o=r.width=40*ft/12,i=r.height=60,a=r.getContext("2d");a.font="36px Arial",a.textAlign="center",a.textBaseline="middle",a.fillStyle="black",a.fillText(e,o/2,.55*i);var s=document.createElement("button");s.id=t,s.className="croquet_dock_button";var u=function(e){e.preventDefault(),e.stopPropagation(),n()};return lt?(s.ontouchstart=u,s.ontouchend=xt,s.onpointerdown=xt,s.onpointerup=xt):(s.onclick=u,s.onpointerdown=xt,s.onpointerup=xt),s.appendChild(r),s}function Ct(e,t){if(!1!==Tt.badge){var n=function(e){for(var t=new I.default(e),n=["bcdfghjklmnpqrstvwxyz","aeiou"],r="",o=0;o<5;o++)r+=n[o%2][t.quick()*n[o%2].length|0];return r}(t);for(document.title=document.title.replace(/:.*/,""),document.title+=":"+n;e.firstChild;)e.removeChild(e.firstChild);var r=document.createElement("canvas"),o=r.width=120,i=r.height=40;r.style.width="100%",e.appendChild(r);var a=r.getContext("2d"),s=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=new I.default(e),r=[],o=0;o<t;o++)r.push("hsl(".concat(360*n.quick(),", 50%, 70%)"));return r}(t,2);a.fillStyle=s[0],a.beginPath(),a.moveTo(0,0),a.lineTo(0,i),a.lineTo(o,0),a.closePath(),a.fill(),a.fillStyle=s[1],a.beginPath(),a.moveTo(o,i),a.lineTo(o,0),a.lineTo(0,i),a.closePath(),a.fill(),a.font="30px Arial",a.textAlign="center",a.textBaseline="middle",a.fillStyle="black",a.fillText(n,o/2,i/2)}}function Ot(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.firstChild;)e.removeChild(e.firstChild);return new je(e,at({text:t,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:je.CorrectLevel.L},n))}var Mt=0;function _t(e){if(kt!==e)if(!1===Tt.sync&&(e=!1),e&&!bt&&(bt=function(){var e=document.createElement("div");e.id="croquet_spinnerOverlay";var t=document.createElement("div");return t.id="croquet_loader",t.innerText="Catching up...",e.appendChild(t),e}()),kt=e,e)clearTimeout(Mt),Mt=setTimeout((function(){kt&&(At(Tt.root,(function(){return document.body})).appendChild(bt),bt.style.opacity=.9)}),500);else{if(!bt)return;clearTimeout(Mt),bt.style.opacity=0,Mt=setTimeout((function(){kt||bt.parentElement&&bt.parentElement.removeChild(bt)}),500)}}function At(e,t){if(!1===e)return!1;if(e instanceof Element)return e;if("string"==typeof e){var n=document.getElementById(e);if(n)return n}return t?t():null}var Tt={sessionURL:window.location.href,root:document.body,sync:!0,messages:!1,badge:!1,stats:!1,qrcode:!1,makeWidgetDock:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!Y.nodock){var t=document.getElementById("croquet_dock");t&&t.parentElement.removeChild(t);var n=At(Tt.root);if(n){var r=document.createElement("div");r.id="croquet_dock",n.appendChild(r);var o,i=document.createElement("div");i.id="croquet_dock_bar",r.appendChild(i),!1!==e.badge&&((o=document.createElement("div")).id="croquet_badge",i.appendChild(o),Tt.badge=o);var a=document.createElement("div");a.id="croquet_dock_content",r.appendChild(a);var s,u,c=[];if(!1!==e.qrcode){var l=Tt.sessionURL;l&&((s=document.createElement("div")).id="croquet_qrcode",a.appendChild(s),c.push(s.id),Tt.qrcode=s)}if(!1!==e.stats&&((u=document.createElement("div")).id="croquet_stats",a.appendChild(u),c.push(u.id),Tt.stats=u),c.length){function f(e){var t,n=c.length,r=0;if(St.activePage){var o=c.indexOf(St.activePage);o>=0?(r=o,t=document.getElementById(St.activePage)):St.activePage=null}var i,a=c[(r+n+e)%n];a===St.activePage?i=t:(t&&t.classList.remove("active"),i=document.getElementById(a)),i&&i.classList.add("active"),St.activePage=a}c.length>1&&(i.appendChild(Et("<","croquet_dock_left",(function(){return f(-1)}))),i.appendChild(Et(">","croquet_dock_right",(function(){return f(1)})))),f(0)}if(!lt&&!e.alwaysPinned){var h=Et("📌","croquet_dock_pin",(function(){St.pinned=!St.pinned,d()})),d=function(){St.pinned?h.classList.add("pinned"):h.classList.remove("pinned")};d(),i.appendChild(h)}var p=200,v=166,y=8,m=function(e){r.style.width="".concat(e,"px");var t=1.18*e;r.style.height="".concat(t,"px");var n=18*e/100;i.style.height="".concat(n,"px"),a.style.top="".concat(n+2,"px"),o&&(o.style.height="".concat(.9*n,"px"),o.style.width="".concat(.9*n*3,"px")),s&&(s.style.border="".concat(y*e/p,"px solid white"))},g=function(){r.style.width=r.style.height="",i.style.height="",a.style.top="",o&&(o.style.height=o.style.width=""),s&&(s.style.border="")},w=e.fixedSize||p,b=function(){return r.classList.contains("active")},k=function(){r.classList.add("active"),m(w),setTimeout((function(){return r.style.transition="none"}),300)},S=function(){r.style.transition="",r.classList.remove("active"),g()};if(lt)S(),r.ontouchstart=function(e){e.preventDefault(),e.stopPropagation(),b()?S():k()},r.ontouchend=xt,r.onpointerdown=xt,r.onpointerup=xt;else if(e.alwaysPinned?k():(St.pinned?k():S(),r.onmouseenter=k,r.onmouseleave=function(){St.pinned||S()}),!e.fixedSize){var x=0;r.onwheel=function(e){e.preventDefault(),e.stopPropagation();var t=Date.now();if(!(t-x<100)){x=t;var n=e.deltaY;n=Math.sign(n)*Math.min(5,Math.abs(n));var o=.8*Math.min(window.innerWidth,window.innerHeight);w=Math.max(v,Math.min(o,r.offsetWidth/Math.pow(1.05,n))),m(w)}}}}}},makeSessionWidgets:function(e){!function(e){if(e&&!1!==Tt.root){var t=At(Tt.badge);t&&Ct(t,e)}}(e),function(){if(!1!==Tt.root&&!1!==Tt.qrcode&&!Y.noqr){var e=Tt.sessionURL;if(e){var t=At(Tt.qrcode);t&&(lt||(t.onclick=function(t){t.preventDefault(),t.stopPropagation(),window.open(e)}),Ot(t,e).getCanvas().style.width="100%")}else console.warn("App.sessionURL is not set")}}(),function(){if(!1!==Tt.root&&!Y.nostats){var e=At(Tt.stats);e&&Ve(e)}}()},makeQRCanvas:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!Tt.sessionURL)return null;var t=document.createElement("div"),n=Ot(t,Tt.sessionURL,e);return n&&n.getCanvas()},clearSessionMoniker:function(){!1!==Tt.badge&&(document.title=document.title.replace(/:.*/,""))},showSyncWait:function(e){!1===Tt.root&&(e=!1),_t(e)},messageFunction:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("once"===t.only){if(pt.has(e))return null;pt.add(e)}var n,r=t.level;return"error"===r?(n="red",console.error(e)):"warning"===r?(n="gold",console.warn(e)):n="#aaa",wt(e,at({backgroundColor:n},t))},showMessage:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Y.nomessages||!1===Tt.root||!1===Tt.messages||!Tt.messageFunction?null:Tt.messageFunction(e,t)},referrerURL:function(){var e=new URL(Tt.sessionURL),t=["croquet.io","croquet.studio","localhost"].includes(e.hostname);return"".concat(e.origin).concat(e.pathname).concat(t?e.search:"")},autoSession:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"q",n=new URL(window.location);if(t){var r=n.search.slice(1).split("&"),o=r.find((function(e){return e.split("=")[0]===t}));e=o?o.replace(/[^=]*=/,""):r.find((function(e){return!e.includes("=")}))||n.hash.slice(1)}else e=n.hash.slice(1);if(e)try{e=decodeURIComponent(e)}catch(e){}else e=Math.floor(Math.random()*Math.pow(36,10)).toString(36),t?n.searchParams.set(t,e):n.hash=e,window.history.replaceState({},"",n),Tt.sessionURL=window.location.href;return window.onhashchange=function(){return window.location.reload()},e}};function It(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=N.default(e);if(t){var o=N.default(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return P.default(this,n)}}var qt=function(e){j.default(n,e);var t=It(n);function n(){return S.default(this,n),t.apply(this,arguments)}return x.default(n,[{key:"poll",value:function(){var e=q.default(N.default(n.prototype),"poll",this).call(this);return this.array[this.size]=null,e}},{key:"asArray",value:function(){var e=[];return this.forEach((function(t){return e.push(t)})),e}},{key:"asUnsortedArray",value:function(){return this.array.slice(0,this.size)}}]),n}(D.default);function jt(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Pt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Pt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function Pt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Nt(e,t){function n(e){var n,r=jt(e);try{for(r.s();!(n=r.n()).done;){var o=n.value;o.for===t&&e.delete(o)}}catch(e){r.e(e)}finally{r.f()}}return n(e.immediate),n(e.oncePerFrame),n(e.oncePerFrameWhileSynced),n(e.queued),e.immediate.size+e.queued.size+e.oncePerFrame.size+e.oncePerFrameWhileSynced.size}var Dt=new(function(){function e(){S.default(this,e),this.subscriptions={},this.queuedEvents=[],this.perFrameEvents=new Map,this.perSyncedFrameEvents=new Map,this.id=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})),this.lastId=0}return x.default(e,[{key:"register",value:function(e){return this.id+"/V"+ ++this.lastId}},{key:"deregister",value:function(e){}},{key:"addSubscription",value:function(e,t,n,r,o){if("vote"!==o){var i=e+":"+t,a=r;a.for=n;var s=this.subscriptions[i];if(s||(s=this.subscriptions[i]={immediate:new Set,queued:new Set,oncePerFrame:new Set,oncePerFrameWhileSynced:new Set}),!s[o])throw Error('Unknown subscribe() option: handling="'.concat(o,'"'));s[o].add(a)}else this.addSubscription(e,t+"#__vote",n,r,"immediate")}},{key:"removeSubscription",value:function(e,t,n){var r=e+":"+t,o=this.subscriptions[r];o&&(0===Nt(o,n)&&delete this.subscriptions[r]);t.endsWith("#__vote")||this.removeSubscription(e,t+"#__vote",n)}},{key:"removeAllSubscriptionsFor",value:function(e){for(var t="".concat(e,":"),n=0,r=Object.entries(this.subscriptions);n<r.length;n++){var o=k.default(r[n],2),i=o[0],a=o[1];if(i.startsWith(t))delete this.subscriptions[i];else 0===Nt(a,e)&&delete this.subscriptions[i]}}},{key:"handleEvent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return e()},r=this.subscriptions[e];r&&(r.queued.size>0&&this.queuedEvents.push({topic:e,data:t}),r.oncePerFrame.size>0&&this.perFrameEvents.set(e,t),r.oncePerFrameWhileSynced.size>0&&this.perSyncedFrameEvents.set(e,t),r.immediate.size>0&&n((function(){var e,n=jt(r.immediate);try{for(n.s();!(e=n.n()).done;){(0,e.value)(t)}}catch(e){n.e(e)}finally{n.f()}})))}},{key:"processFrameEvents",value:function(e){var t,n=this,r=0,o=function(e,t,o){var i=n.subscriptions[e];if(i){var a,s=jt(i[o]);try{for(s.s();!(a=s.n()).done;){(0,a.value)(t),r++}}catch(e){s.e(e)}finally{s.f()}}},i=jt(this.queuedEvents);try{for(i.s();!(t=i.n()).done;){var a=t.value;o(a.topic,a.data,"queued")}}catch(e){i.e(e)}finally{i.f()}this.queuedEvents.length=0;var s,u=jt(this.perFrameEvents);try{for(u.s();!(s=u.n()).done;){var c=k.default(s.value,2);o(c[0],c[1],"oncePerFrame")}}catch(e){u.e(e)}finally{u.f()}if(this.perFrameEvents.clear(),e){var l,f=jt(this.perSyncedFrameEvents);try{for(f.s();!(l=f.n()).done;){var h=k.default(l.value,2);o(h[0],h[1],"oncePerFrameWhileSynced")}}catch(e){f.e(e)}finally{f.f()}this.perSyncedFrameEvents.clear()}var d,p=jt(this.queuedEvents);try{for(p.s();!(d=p.n()).done;){var v=d.value;o(v.topic,v.data,"queued")}}catch(e){p.e(e)}finally{p.f()}return this.queuedEvents.length=0,r}}]),e}());var Lt={get subscribe(){return(Lt={subscribe:Y.has("debug","subscribe",!1)}).subscribe}},Rt=function(){function e(t){S.default(this,e),this.island=t}return x.default(e,[{key:"register",value:function(e){return this.island.registerModel(e)}},{key:"deregister",value:function(e){this.island.deregisterModel(e.id)}},{key:"publish",value:function(e,t,n){this.island.publishFromModel(n,e,t)}},{key:"subscribe",value:function(e,t,n,r){return Lt.subscribe&&console.log('Model.subscribe("'.concat(t,":").concat(n,'", ').concat(e," ").concat((""+r).replace(/\([\s\S]*/,""),")")),this.island.addSubscription(e,t,n,r)}},{key:"unsubscribe",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"*";Lt.subscribe&&console.log("Model.unsubscribe(".concat(t,":").concat(n,'", ').concat(e," ").concat((""+r).replace(/\([\s\S]*/,""),")")),this.island.removeSubscription(e,t,n,r)}},{key:"unsubscribeAll",value:function(e){Lt.subscribe&&console.log("Model.unsubscribeAll(".concat(e," ").concat(e.id,")")),this.island.removeAllSubscriptionsFor(e)}},{key:"future",value:function(e,t,n,r){if(Ut&&Ut.equal(this))return this.island.future(e,t,n,r);if(t)throw Error("tOffset not supported from cross-realm future send yet.");var o=this.island;return new Proxy(e,{get:function(t,n){if("function"==typeof e[n])return new Proxy(e[n],{apply:function(t,r,i){o.callModelMethod(e.id,n,i)}});throw Error("Tried to call "+n+"() on future of "+Object.getPrototypeOf(e).constructor.name+" which is not a function")}})}},{key:"random",value:function(){return this.island.random()}},{key:"now",value:function(){return this.island.time}},{key:"equal",value:function(t){return t instanceof e&&t.island===this.island}}]),e}(),Bt=function(){function e(t){S.default(this,e),this.island=t}return x.default(e,[{key:"register",value:function(e){return Dt.register(e)}},{key:"deregister",value:function(e){Dt.deregister(e)}},{key:"publish",value:function(e,t,n){this.island.publishFromView(n,e,t)}},{key:"subscribe",value:function(e,t,n,r){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"queued";Lt.subscribe&&console.log('View.subscribe("'.concat(r,":").concat(e,'", ').concat(t," ").concat(n.name||(""+n).replace(/\([\s\S]*/,"")," [").concat(o,"])")),Dt.addSubscription(r,e,t,n,o)}},{key:"unsubscribe",value:function(e,t,n,r){Lt.subscribe&&console.log('View.unsubscribe("'.concat(r,":").concat(e,'", ').concat(t," ").concat(n.name||(""+n).replace(/\([\s\S]*/,""),")")),Dt.removeSubscription(r,e,t,n)}},{key:"unsubscribeAll",value:function(e){Lt.subscribe&&console.log("View.unsubscribeAll(".concat(e,")")),Dt.removeAllSubscriptionsFor(e)}},{key:"future",value:function(e,t){return t?new Proxy(e,{get:function(n,r){if("function"==typeof e[r])return new Proxy(e[r],{apply:function(n,o,i){setTimeout((function(){e.id&&e[r].apply(e,E.default(i))}),t)}});throw Error("Tried to call "+r+"() on future of "+Object.getPrototypeOf(e).constructor.name+" which is not a function")}}):e}},{key:"random",value:function(){return Math.random()}},{key:"now",value:function(){return this.island.time}},{key:"externalNow",value:function(){return this.island.controller.time}},{key:"isSynced",value:function(){return!!this.island.controller.synced}},{key:"equal",value:function(t){return t instanceof e&&t.island===this.island}}]),e}(),Ut=null;function Ft(){if(!Ut)throw Error("Tried to execute code that requires realm outside of realm.");return Ut}function Ht(e,t){if(null!==Ut)throw Error("Can't switch realms from inside realm");try{return Ut=new Rt(e),t()}finally{Ut=null}}function $t(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==Ut&&!n)throw Error("Can't switch realms from inside realm");var r=Ut;try{return Ut=new Bt(e),t()}finally{Ut=r}}function Jt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=N.default(e);if(t){var o=N.default(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return P.default(this,n)}}function zt(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Wt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Wt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function Wt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}!function(){var e,t=function(e){return e!=e},n=Math.sqrt,r=.7853981633974483,o=function(e){var o,i,a,s,u;if(t(e))return NaN;if(e>0?a=e:(o=!0,a=-e),a>1)return NaN;if(a>.625)s=(i=1-a)*function(e){var t,n;return 0===e?.08333333333333809:((e<0?-e:e)<=1?(t=28.536655482610616+e*(e*(6.968710824104713+e*(.002967721961301243*e-.5634242780008963))-25.56901049652825),n=342.43986579130785+e*(e*(147.0656354026815+e*(1*e-21.947795316429207))-383.8770957603691)):(t=.002967721961301243+(e=1/e)*(e*(6.968710824104713+e*(28.536655482610616*e-25.56901049652825))-.5634242780008963),n=1+e*(e*(147.0656354026815+e*(342.43986579130785*e-383.8770957603691))-21.947795316429207)),t/n)}(i),i=n(i+i),u=r-i,u-=i=i*s-6123233995736766e-32,u+=r;else{if(a<1e-8)return e;u=a*(u=(i=a*a)*function(e){var t,n;return 0===e?.16666666666666713:((e<0?-e:e)<=1?(t=e*(19.562619833175948+e*(e*(5.444622390564711+e*(.004253011369004428*e-.6019598008014124))-16.262479672107002))-8.198089802484825,n=e*(139.51056146574857+e*(e*(70.49610280856842+e*(1*e-14.740913729888538))-147.1791292232726))-49.18853881490881):(t=.004253011369004428+(e=1/e)*(e*(5.444622390564711+e*(e*(19.562619833175948+-8.198089802484825*e)-16.262479672107002))-.6019598008014124),n=1+e*(e*(70.49610280856842+e*(e*(139.51056146574857+-49.18853881490881*e)-147.1791292232726))-14.740913729888538)),t/n)}(i))+a}return o?-u:u},i="function"==typeof Symbol&&"symbol"==C.default(Symbol("foo")),a=Object.prototype.toString,s=Object.prototype.hasOwnProperty,u="function"==typeof Symbol?Symbol.toStringTag:"",c={};e=i&&"symbol"==C.default(Symbol.toStringTag)?function(e){var t,n,r;if(null==e)return a.call(e);n=e[u],t=function(e,t){return null!=e&&s.call(e,t)}(e,u);try{e[u]=void 0}catch(t){return a.call(e)}return r=a.call(e),t?e[u]=n:delete e[u],r}:function(e){return a.call(e)},c=e;var l="function"==typeof Uint32Array,f="function"==typeof Uint32Array?Uint32Array:null,h="function"==typeof Uint32Array?Uint32Array:null,d={};d=function(){var e,t;if("function"!=typeof f)return!1;try{e=function(e){return l&&e instanceof Uint32Array||"[object Uint32Array]"===c(e)}(t=new f(t=[1,3.14,-3.14,4294967296,4294967297]))&&1===t[0]&&3===t[1]&&4294967293===t[2]&&0===t[3]&&1===t[4]}catch(t){e=!1}return e}()?h:function(){throw new Error("not implemented")};var p="function"==typeof Float64Array,v="function"==typeof Float64Array?Float64Array:null,y="function"==typeof Float64Array?Float64Array:null,m={};m=function(){var e,t;if("function"!=typeof v)return!1;try{e=function(e){return p&&e instanceof Float64Array||"[object Float64Array]"===c(e)}(t=new v([1,3.14,-3.14,NaN]))&&1===t[0]&&3.14===t[1]&&-3.14===t[2]&&t[3]!=t[3]}catch(t){e=!1}return e}()?y:function(){throw new Error("not implemented")};var g,w="function"==typeof Uint8Array,b="function"==typeof Uint8Array?Uint8Array:null,k="function"==typeof Uint8Array?Uint8Array:null;g=function(){var e,t;if("function"!=typeof b)return!1;try{e=function(e){return w&&e instanceof Uint8Array||"[object Uint8Array]"===c(e)}(t=new b(t=[1,3.14,-3.14,256,257]))&&1===t[0]&&3===t[1]&&253===t[2]&&0===t[3]&&1===t[4]}catch(t){e=!1}return e}()?k:function(){throw new Error("not implemented")};var S,x="function"==typeof Uint16Array,E="function"==typeof Uint16Array?Uint16Array:null,O="function"==typeof Uint16Array?Uint16Array:null,M={uint16:function(){var e,t;if("function"!=typeof E)return!1;try{e=function(e){return x&&e instanceof Uint16Array||"[object Uint16Array]"===c(e)}(t=new E(t=[1,3.14,-3.14,65536,65537]))&&1===t[0]&&3===t[1]&&65533===t[2]&&0===t[3]&&1===t[4]}catch(t){e=!1}return e}()?O:function(){throw new Error("not implemented")},uint8:g};(S=new M.uint16(1))[0]=4660;var _,A=52===new M.uint8(S.buffer)[0];_=!0===A?1:0;var T,I=new m(1),q=new d(I.buffer),j=function(e){return I[0]=e,q[_]};T=!0===A?1:0;var P,N,D,L=new m(1),R=new d(L.buffer),B=function(e,t){return L[0]=e,R[T]=t>>>0,L[0]},U=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,H=.6931471803691238,$=1.9082149292705877e-10,J=function(e){var n,r,o,i,a,s,u,c,l,f;if(e<-1||t(e))return NaN;if(-1===e)return F;if(e===U)return e;if(0===e)return e;if(f=1,(o=e<0?-e:e)<.41421356237309503){if(o<1.862645149230957e-9)return o<5551115123125783e-32?e:e-e*e*.5;e>-.2928932188134525&&(f=0,i=e,r=1)}return 0!==f&&(o<9007199254740992?(a=(f=((r=j(l=1+e))>>20)-1023)>0?1-(l-e):e-(l-1),a/=l):(f=((r=j(l=e))>>20)-1023,a=0),(r&=1048575)<434334?l=B(l,1072693248|r):(f+=1,l=B(l,1071644672|r),r=1048576-r>>2),i=l-1),n=.5*i*i,0===r?0===i?f*H+(a+=f*$):f*H-((c=n*(1-.6666666666666666*i))-(f*$+a)-i):(c=(u=(s=i/(2+i))*s)*function(e){return 0===e?.6666666666666735:.6666666666666735+e*(.3999999999940942+e*(.2857142874366239+e*(.22222198432149784+e*(.1818357216161805+e*(.15313837699209373+.14798198605116586*e)))))}(u),0===f?i-(n-s*(n+c)):f*H-(n-(s*(n+c)+(f*$+a))-i))},z=.6931471805599453,W=1.9082149292705877e-10,V=function(e){var n,r,o,i,a,s,u,c,l,f,h;return 0===e?F:t(e)||e<0?NaN:(i=0,(r=j(e))<1048576&&(i-=54,r=j(e*=0x40000000000000)),r>=2146435072?e+e:(i+=(r>>20)-1023|0,i+=(u=614244+(r&=1048575)&1048576|0)>>20|0,s=(e=B(e,r|1072693248^u))-1,(1048575&2+r)<3?0===s?0===i?0:.6931471803691238*i+i*W:(a=s*s*(.5-.3333333333333333*s),0===i?s-a:.6931471803691238*i-(a-i*W-s)):(u=r-398458|0,c=440401-r|0,o=(f=(h=(l=s/(2+s))*l)*h)*function(e){return 0===e?.3999999999940942:.3999999999940942+e*(.22222198432149784+.15313837699209373*e)}(f),a=h*function(e){return 0===e?.6666666666666735:.6666666666666735+e*(.2857142874366239+e*(.1818357216161805+.14798198605116586*e))}(f)+o,(u|=c)>0?(n=.5*s*s,0===i?s-(n-l*(n+a)):.6931471803691238*i-(n-(l*(n+a)+i*W)-s)):0===i?s-l*(s-a):.6931471803691238*i-(l*(s-a)-i*W-s))))},G=function(e){return e===U||e===F},K=1.5707963267948966,Q=function(e){var n,o,i,a;return t(e)||0===e?e:e===U?K:e===F?-K:(e<0&&(o=!0,e=-e),n=0,e>2.414213562373095?(i=K,n=1,e=-1/e):e<=.66?i=0:(i=r,n=2,e=(e-1)/(e+1)),a=e*(a=(a=e*e)*function(e){return 0===e?-64.85021904942025:e*(e*(e*(-.8750608600031904*e-16.157537187333652)-75.00855792314705)-122.88666844901361)-64.85021904942025}(a)/function(e){return 0===e?194.5506571482614:194.5506571482614+e*(485.3903996359137+e*(432.88106049129027+e*(165.02700983169885+e*(24.858464901423062+1*e))))}(a))+e,2===n?a+=3061616997868383e-32:1===n&&(a+=6123233995736766e-32),i+=a,o?-i:i)};!0===A?(N=1,D=0):(N=0,D=1),P={HIGH:N,LOW:D};var Y,X,Z,ee=new m(1),te=new d(ee.buffer),ne=P.HIGH,re=P.LOW,oe=function(e,t){return ee[0]=t,e[0]=te[ne],e[1]=te[re],e},ie=function(e,t){return 1===arguments.length?oe([0,0],e):oe(e,t)};!0===A?(X=1,Z=0):(X=0,Z=1),Y={HIGH:X,LOW:Z};var ae,se=new m(1),ue=new d(se.buffer),ce=Y.HIGH,le=Y.LOW,fe=function(e,t){return ue[ce]=e,ue[le]=t,se[0]},he=[0,0],de=function(e,t){var n,r;return ie(he,e),n=he[0],n&=2147483647,r=j(t),fe(n|=r&=2147483648,he[1])},pe=3.141592653589793,ve=function(e,t){var n,r,o,i;return o=(i=e*e)*i,r=i*function(e){return 0===e?.0416666666666666:.0416666666666666+e*(2480158728947673e-20*e-.001388888888887411)}(i),r+=o*o*function(e){return 0===e?-2.7557314351390663e-7:e*(2.087572321298175e-9+-11359647557788195e-27*e)-2.7557314351390663e-7}(i),(o=1-(n=.5*i))+(1-o-n+(i*r-e*t))},ye=-.16666666666666632,me=function(e,t){var n,r,o;return n=.00833333333332249+(o=e*e)*(27557313707070068e-22*o-.0001984126982985795)+o*(o*o)*(1.58969099521155e-10*o-2.5050760253406863e-8),r=o*e,0===t?e+r*(ye+o*n):e-(o*(.5*t-r*n)-t-r*ye)};ae=!0===A?0:1;var ge=new m(1),we=new d(ge.buffer),be=Math.floor,ke=function(e){return e<0?-e:0===e?0:e},Se=function(e,n){return t(n)||G(n)?(e[0]=n,e[1]=0,e):0!==n&&ke(n)<22250738585072014e-324?(e[0]=4503599627370496*n,e[1]=-52,e):(e[0]=n,e[1]=0,e)},xe=[0,0],Ee=[0,0],Ce=function(e,n){var r,o;return 0===e||t(e)||G(e)?e:(function(e,t){1===arguments.length?Se([0,0],e):Se(e,t)}(xe,e),n+=xe[1],(n+=function(e){var t=j(e);return(t=(2146435072&t)>>>20)-1023|0}(e=xe[0]))<-1074?de(0,e):n>1023?e<0?F:U:(n<=-1023?(n+=52,o=2220446049250313e-31):o=1,ie(Ee,e),r=Ee[0],r&=2148532223,o*fe(r|=n+1023<<20,Ee[1])))},Oe=[10680707,7228996,1387004,2578385,16069853,12639074,9804092,4427841,16666979,11263675,12935607,2387514,4345298,14681673,3074569,13734428,16653803,1880361,10960616,8533493,3062596,8710556,7349940,6258241,3772886,3769171,3798172,8675211,12450088,3874808,9961438,366607,15675153,9132554,7151469,3571407,2607881,12013382,4155038,6285869,7677882,13102053,15825725,473591,9065106,15363067,6271263,9264392,5636912,4652155,7056368,13614112,10155062,1944035,9527646,15080200,6658437,6231200,6832269,16767104,5075751,3212806,1398474,7579849,6349435,12618859],Me=[1.570796251296997,7.549789415861596e-8,5390302529957765e-30,3282003415807913e-37,1270655753080676e-44,12293330898111133e-52,27337005381646456e-60,21674168387780482e-67],_e=5.960464477539063e-8,Ae=je(new Array(20)),Te=je(new Array(20)),Ie=je(new Array(20)),qe=je(new Array(20));function je(e){var t,n=e.length;for(t=0;t<n;t++)e[t]=0;return e}var Pe,Ne=Math.round,De=function(e,t,n){var r,o,i,a,s;return i=e-1.5707963267341256*(r=Ne(.6366197723675814*e)),a=6077100506506192e-26*r,s=t>>20|0,n[0]=i-a,s-(j(n[0])>>20&2047)>16&&(a=20222662487959506e-37*r-((o=i)-(i=o-(a=6077100506303966e-26*r))-a),n[0]=i-a,s-(j(n[0])>>20&2047)>49&&(a=84784276603689e-45*r-((o=i)-(i=o-(a=20222662487111665e-37*r))-a),n[0]=i-a)),n[1]=i-n[0]-a,r},Le=1.5707963267341256,Re=6077100506506192e-26,Be=2*Re,Ue=4*Re,Fe=new Array(3),He=new Array(2),$e=function(e,t){var n,r,o,i,a,s,u;if((o=2147483647&j(e)|0)<=1072243195)return t[0]=e,t[1]=0,0;if(o<=1074752122)return 598523==(1048575&o)?De(e,o,t):o<=1073928572?e>0?(u=e-Le,t[0]=u-Re,t[1]=u-t[0]-Re,1):(u=e+Le,t[0]=u+Re,t[1]=u-t[0]+Re,-1):e>0?(u=e-2*Le,t[0]=u-Be,t[1]=u-t[0]-Be,2):(u=e+2*Le,t[0]=u+Be,t[1]=u-t[0]+Be,-2);if(o<=1075594811)return o<=1075183036?1074977148===o?De(e,o,t):e>0?(u=e-3*Le,t[0]=u-1.8231301519518578e-10,t[1]=u-t[0]-1.8231301519518578e-10,3):(u=e+3*Le,t[0]=u+1.8231301519518578e-10,t[1]=u-t[0]+1.8231301519518578e-10,-3):1075388923===o?De(e,o,t):e>0?(u=e-4*Le,t[0]=u-Ue,t[1]=u-t[0]-Ue,4):(u=e+4*Le,t[0]=u+Ue,t[1]=u-t[0]+Ue,-4);if(o<1094263291)return De(e,o,t);if(o>=2146435072)return t[0]=NaN,t[1]=NaN,0;for(n=function(e){return ge[0]=e,we[ae]}(e),u=fe(o-((r=(o>>20)-1046)<<20|0),n),a=0;a<2;a++)Fe[a]=0|u,u=16777216*(u-Fe[a]);for(Fe[2]=u,i=3;0===Fe[i-1];)i-=1;return s=function(e,t,n,r){var o,i,a,s,u,c,l;for((i=(n-3)/24|0)<0&&(i=0),s=n-24*(i+1),c=i-(a=r-1),l=a+4,u=0;u<=l;u++)Ae[u]=c<0?0:Oe[c],c+=1;for(u=0;u<=4;u++){for(o=0,c=0;c<=a;c++)o+=e[c]*Ae[a+(u-c)];Te[u]=o}return function e(t,n,r,o,i,a,s,u,c){var l,f,h,d,p,v,y,m,g;for(d=a,g=o[r],m=r,p=0;m>0;p++)f=_e*g|0,qe[p]=g-16777216*f|0,g=o[m-1]+f,m-=1;if(g=Ce(g,i),g-=8*be(.125*g),g-=y=0|g,h=0,i>0?(y+=p=qe[r-1]>>24-i,qe[r-1]-=p<<24-i,h=qe[r-1]>>23-i):0===i?h=qe[r-1]>>23:g>=.5&&(h=2),h>0){for(y+=1,l=0,p=0;p<r;p++)m=qe[p],0===l?0!==m&&(l=1,qe[p]=16777216-m):qe[p]=16777215-m;if(i>0)switch(i){case 1:qe[r-1]&=8388607;break;case 2:qe[r-1]&=4194303}2===h&&(g=1-g,0!==l&&(g-=Ce(1,i)))}if(0===g){for(m=0,p=r-1;p>=a;p--)m|=qe[p];if(0===m){for(v=1;0===qe[a-v];v++);for(p=r+1;p<=r+v;p++){for(c[u+p]=Oe[s+p],f=0,m=0;m<=u;m++)f+=t[m]*c[u+(p-m)];o[p]=f}return e(t,n,r+=v,o,i,a,s,u,c)}}if(0===g)for(r-=1,i-=24;0===qe[r];)r-=1,i-=24;else(g=Ce(g,-i))>=16777216?(f=_e*g|0,qe[r]=g-16777216*f|0,i+=24,qe[r+=1]=f):qe[r]=0|g;for(f=Ce(1,i),p=r;p>=0;p--)o[p]=f*qe[p],f*=_e;for(p=r;p>=0;p--){for(f=0,v=0;v<=d&&v<=r-p;v++)f+=Me[v]*o[p+v];Ie[r-p]=f}for(f=0,p=r;p>=0;p--)f+=Ie[p];for(n[0]=0===h?f:-f,f=Ie[0]-f,p=1;p<=r;p++)f+=Ie[p];return n[1]=0===h?f:-f,7&y}(e,t,4,Te,s,4,i,a,Ae)}(Fe,He,r,i),e<0?(t[0]=-He[0],t[1]=-He[1],-s):(t[0]=He[0],t[1]=He[1],s)},Je=[0,0],ze=Math.ceil,We=function(e){var n;return t(e)||e===U?e:e===F?0:e>709.782712893384?U:e<-745.1332191019411?0:e>-1/(1<<28)&&e<1/(1<<28)?1+e:function(e,t,n){var r,o,i,a;return i=(r=e-t)-(o=r*r)*(0===(a=o)?.16666666666666602:.16666666666666602+a*(a*(6613756321437934e-20+a*(4.1381367970572385e-8*a-16533902205465252e-22))-.0027777777777015593)),Ce(1-(t-r*i/(2-i)-e),n)}(e-.6931471803691238*(n=function(e){return e<0?ze(e):be(e)}(e<0?1.4426950408889634*e-.5:1.4426950408889634*e+.5)),1.9082149292705877e-10*n,n)};Pe=!0===A?0:1;var Ve=new m(1),Ge=new d(Ve.buffer),Ke=function(e,t){return Ve[0]=e,Ge[Pe]=t>>>0,Ve[0]},Qe=[0,0],Ye=[0,0],Xe=function(e,t,n){var r,o,i,a,s,u,c,l,f;return(o=2147483647&(r=j(e))|0)>=1072010280&&(e<0&&(e=-e,t=-t),e=(f=.7853981633974483-e)+(l=3061616997868383e-32-t),t=0),a=t+(f=e*e)*((s=f*e)*((a=function(e){return 0===e?.13333333333320124:.13333333333320124+e*(.021869488294859542+e*(.0035920791075913124+e*(.0005880412408202641+e*(7817944429395571e-20+-18558637485527546e-21*e))))}(l=f*f))+(c=f*function(e){return 0===e?.05396825397622605:.05396825397622605+e*(.0088632398235993+e*(.0014562094543252903+e*(.0002464631348184699+e*(7140724913826082e-20+2590730518636337e-20*e))))}(l)))+t),l=e+(a+=.3333333333333341*s),o>=1072010280?(1-(r>>30&2))*((c=n)-2*(e-(l*l/(l+c)-a))):1===n?l:(Ke(f=l,0),c=a-(f-e),Ke(u=i=-1/l,0),u+i*((s=1+u*f)+u*c))},Ze=[0,0];void 0===window.CroquetMath&&(window.CroquetMath={}),window.CroquetMath.acos=function(e){var i;return t(e)||e<-1||e>1?NaN:e>.5?2*o(n(.5-.5*e)):(i=r-o(e),i+=6123233995736766e-32,i+=r)},window.CroquetMath.acosh=function(e){var r;return t(e)||e<1?NaN:1===e?0:e>=1<<28?V(e)+z:e>2?V(2*e-1/(e+n(e*e-1))):J((r=e-1)+n(2*r+r*r))},window.CroquetMath.asin=o,window.CroquetMath.asinh=function(e){var r,o,i;return t(e)||G(e)?e:(e<0&&(e=-e,r=!0),i=e<1/(1<<28)?e:e>1<<28?V(e)+z:e>2?V(2*e+1/(n(e*e+1)+e)):J(e+(o=e*e)/(1+n(1+o))),r?-i:i)},window.CroquetMath.atan=Q,window.CroquetMath.atanh=function(e){var n,r;return t(e)||e<-1||e>1?NaN:1===e?U:-1===e?F:(e<0&&(n=!0,e=-e),e<1/(1<<28)?n?-e:e:(r=e<.5?.5*J((r=e+e)+r*e/(1-e)):.5*J((e+e)/(1-e)),n?-r:r))},window.CroquetMath.atan2=function(e,n){var r;return t(n)||t(e)?NaN:G(n)?n===U?G(e)?de(pe/4,e):de(0,e):G(e)?de(3*pe/4,e):de(pe,e):G(e)?de(pe/2,e):0===e?n>=0&&!function(e){return!!(j(e)>>>31)}(n)?de(0,e):de(pe,e):0===n?de(pe/2,e):(r=Q(e/n),n<0?r<=0?r+pe:r-pe:r)},window.CroquetMath.cbrt=function(e){var n,r,o,i,a;return t(e)||G(e)||0===e?e:(r=-2147483648&(o=j(e)),o&=2147483647,a=0,e<22250738585072014e-324?(a=0x40000000000000,n=j(a*=e),a=fe(r|(n=(2147483647&n)/3+696219795),0)):a=B(a,r|(n=o/3+715094163)),a*=function(e){return 0===e?1.87595182427177:1.87595182427177+e*(e*(1.6214297201053545+e*(.14599619288661245*e-.758397934778766))-1.8849797954337717)}(i=a*a*(a/e)),n=j(a),a=fe(n+1,0),a+=a*(i=((i=e/(a*a))-a)/(a+a+i)))},window.CroquetMath.cos=function(e){var t;if(t=j(e),(t&=2147483647)<=1072243195)return t<1044381696?1:ve(e,0);if(t>=2146435072)return NaN;switch(3&$e(e,Je)){case 0:return ve(Je[0],Je[1]);case 1:return-me(Je[0],Je[1]);case 2:return-ve(Je[0],Je[1]);default:return me(Je[0],Je[1])}},window.CroquetMath.cosh=function(e){return t(e)?e:(e<0&&(e=-e),e>21?We(e)/2:(We(e)+We(-e))/2)},window.CroquetMath.exp=We,window.CroquetMath.expm1=function(e){var n,r,o,i,a,s,u,c,l,f,h,d;if(e===U||t(e))return e;if(e===F)return-1;if(0===e)return e;if(e<0?(r=!0,u=-e):(r=!1,u=e),u>=38.816242111356935){if(r)return-1;if(u>=709.782712893384)return U}if(a=0|j(u),u>.34657359027997264)u<1.0397207708399179?r?(o=e+.6931471803691238,i=-1.9082149292705877e-10,d=-1):(o=e-.6931471803691238,i=1.9082149292705877e-10,d=1):(d=r?1.4426950408889634*e-.5:1.4426950408889634*e+.5,o=e-.6931471803691238*(f=d|=0),i=1.9082149292705877e-10*f),l=o-(e=o-i)-i;else{if(a<1016070144)return e;d=0}return h=(c=e*(n=.5*e))*(((s=1+c*function(e){return 0===e?-.03333333333333313:e*(.0015873015872548146+e*(e*(4008217827329362e-21+-2.0109921818362437e-7*e)-793650757867488e-19))-.03333333333333313}(c))-(f=3-s*n))/(6-e*f)),0===d?e-(e*h-c):(h=e*(h-l)-l,h-=c,-1===d?.5*(e-h)-.5:1===d?e<-.25?-2*(h-(e+.5)):1+2*(e-h):d<=-2||d>56?(o=j(u=1-(h-e))+(d<<20)|0,(u=B(u,o))-1):(f=1,d<20?u=(f=B(f,o=1072693248-(2097152>>d)|0))-(h-e):(u=e-(h+(f=B(f,o=1023-d<<20|0))),u+=1),o=j(u)+(d<<20)|0,B(u,o)))},window.CroquetMath.log=V,window.CroquetMath.log1p=J,window.CroquetMath.log10=function(e){var n,r,o,i,a,s,u;return t(e)||e<0?NaN:0===e?F:(a=0,(r=j(e))<1048576&&(a-=54,r=j(e*=0x40000000000000)),r>=2146435072?e+e:(a+=(r>>20)-1023|0,e=B(e,(r&=1048575)|1072693248^(i=r+614244&1048576|0)),s=a+=i>>20|0,o=function(e){var t,n,r,o,i,a,s,u,c,l;return o=e-1,(1048575&2+(r=j(e)))<3?0===o?0:o*o*(.3333333333333333*o-.5):(c=(r&=1048575)-398458|0,l=440401-r|0,n=(u=(a=(i=o/(2+o))*i)*a)*function(e){return 0===e?.3999999999940942:.3999999999940942+e*(.22222198432149784+.15313837699209373*e)}(u),s=a*function(e){return 0===e?.6666666666666735:.6666666666666735+e*(.2857142874366239+e*(.1818357216161805+.14798198605116586*e))}(u)+n,(c|=l)>0?i*((t=.5*o*o)+s)-t:i*(s-o))}(e),n=Ke(e-=1,0),u=3694239077158931e-28*s+25082946711645275e-27*(e+o),(u+=.4342944818781689*(e-n+o)+.4342944818781689*n)+.30102999566361177*s))},window.CroquetMath.log2=function(e){var n,r,o,i,a;if(t(e)||e<0)return NaN;if(ie(Qe,e),a=0,(r=Qe[0])<1048576){if(0==(2147483647&r|Qe[1]))return F;a-=54,r=j(e*=0x40000000000000)}return r>=2146435072?e+e:(a+=(r>>20)-1023|0,e=B(e,(r&=1048575)|1072693248^(i=r+614244&1048576|0)),a+=i>>20|0,o=function(e){var t,n,r,o,i,a,s,u,c,l;return o=e-1,(1048575&2+(r=j(e)))<3?0===o?0:o*o*(.3333333333333333*o-.5):(c=(r&=1048575)-398458|0,l=440401-r|0,n=(u=(a=(i=o/(2+o))*i)*a)*function(e){return 0===e?.3999999999940942:.3999999999940942+e*(.22222198432149784+.15313837699209373*e)}(u),s=a*function(e){return 0===e?.6666666666666735:.6666666666666735+e*(.2857142874366239+e*(.1818357216161805+.14798198605116586*e))}(u)+n,(c|=l)>0?i*((t=.5*o*o)+s)-t:i*(s-o))}(e),n=Ke(e-=1,0),1.6751713164886512e-10*(e+o)+1.4426950407214463*(e-n+o)+1.4426950407214463*n+a)},window.CroquetMath.sin=function(e){var t;if(t=j(e),(t&=2147483647)<=1072243195)return t<1045430272?e:me(e,0);if(t>=2146435072)return NaN;switch(3&$e(e,Ye)){case 0:return me(Ye[0],Ye[1]);case 1:return ve(Ye[0],Ye[1]);case 2:return-me(Ye[0],Ye[1]);default:return-ve(Ye[0],Ye[1])}},window.CroquetMath.sinh=function(e){var t;return 0===e?e:(t=ke(e),e>710.4758600739439||e<-709.089565712824?e>0?U:F:t>1?t>=709.0895657128241?(t=We(.5*t),t*=.5*t,e<0&&(t=-t),t):(t=.5*(t=We(t))-.5/t,e<0&&(t=-t),t):e+e*(t*=t)*function(e){var t,n;return 0===e?.16666666666666666:((e<0?-e:e)<=1?(t=e*(e*(-.789474443963537*e-163.72585752598383)-11561.443576500522)-351754.9648081514,n=e*(36157.827983443196+e*(1*e-277.7110814206028))-2110529.7888489086):(t=(e=1/e)*(e*(-351754.9648081514*e-11561.443576500522)-163.72585752598383)-.789474443963537,n=1+e*(e*(36157.827983443196+-2110529.7888489086*e)-277.7110814206028)),t/n)}(t))},window.CroquetMath.tan=function(e){var t,n;return t=j(e),(t&=2147483647)<=1072243195?t<1044381696?e:Xe(e,0,1):t>=2146435072?NaN:(n=$e(e,Ze),Xe(Ze[0],Ze[1],1-((1&n)<<1)))},window.CroquetMath.tanh=function(e){var t,n;if((n=ke(e))>44.014845965556525)return e<0?-1:1;if(n>=.625)n=1-2/((t=We(2*n))+1),e<0&&(n=-n);else{if(0===e)return e;n=e+e*(t=e*e)*function(e){var t,n;return 0===e?-.3333333333333332:((e<0?-e:e)<=1?(t=e*(e*(0*e-.9643991794250523)-99.28772310019185)-1614.6876844170845,n=4844.063053251255+e*(2235.4883906010045+e*(112.81167849163293+1*e))):(t=0+(e=1/e)*(e*(-1614.6876844170845*e-99.28772310019185)-.9643991794250523),n=1+e*(112.81167849163293+e*(2235.4883906010045+4844.063053251255*e))),t/n)}(t)}return n};var et=Math.pow;function tt(e){return e===1/0||e===-1/0}window.CroquetMath.pow=function(e,t){if(isNaN(e)||isNaN(t))return NaN;if(tt(e)||tt(t))return et(e,t);if(0===e||0===t)return et(e,t);if(e<0&&!function(e){return Number.isInteger(e)}(t))return NaN;if(1===t)return e;if(2===t)return e*e;if(3===t)return e*e*e;if(4===t)return e*e*e*e;var n=1;return e<0&&(e*=-1,n=et(-1,t)),window.CroquetMath.exp(window.CroquetMath.log(e)*t)*n}}();var Vt=null,Gt={};function Kt(e,t){var n=JSON.parse(atob(e.slice(1,-1))),r=n.qPara,o=n.qArgs,i=n.qFn,a=JSON.stringify(r),s=Gt[a]||(Gt[a]=R.default(Function,E.default(r)));return"number"==typeof i&&(o[i]=s),s.call.apply(s,[t].concat(E.default(o))).bind(t)}function Qt(e,t){if(Vt)throw Error("Island confusion");if(!(e instanceof Yt))throw Error("not an island: "+e);var n=Vt;try{Vt=e,window.ISLAND=e,t()}finally{Vt=n}}var Yt=function(){function e(t,n){var r=this;S.default(this,e),e.installCustomMath(),Qt(this,(function(){Ht(r,(function(){if(r.modelsById={},r.modelsByName={},r.messages=new qt((function(e,t){return e.before(t)})),r.subscriptions={},r.users={},r._random=function(){throw Error("You must not use random when applying state!")},r.id=t.id,r.time=0,r.seq=4294967280,r.externalTime=0,r.externalSeq=r.seq,r.futureSeq=0,r.tuttiSeq=0,r.lastSnapshotPoll=0,r.modelsId=0,t.modelsById){for(var e=un.newOrRecycled(r).readIsland(t,"$"),o=[],i=0,a=Object.keys(e);i<a.length;i++){var s=a[i];s in r||"meta"===s?"messages"===s?o=e.messages:r[s]=e[s]:console.warn("Ignoring property snapshot.".concat(s))}var u,c=zt(o);try{for(c.s();!(u=c.n()).done;){var l=u.value;r.messages.add(l.convertIfNeeded(r))}}catch(e){c.e(e)}finally{c.f()}}else{r._random=new I.default(t.id,{state:!0});var f=n(r)||{};Object.assign(r.modelsByName,f),r.addSubscription(r,r.id,"__users__",r.generateJoinExit)}}))}))}return x.default(e,null,[{key:"current",value:function(){return Vt||console.warn("No CurrentIsland!"),Vt}},{key:"hasCurrent",value:function(){return!!Vt}},{key:"installCustomMath",value:function(){if(!window.BrowserMath){window.CroquetMath.random=function(){return Vt.random()},window.BrowserMath={};for(var e=function(){var e=k.default(n[t],2),r=e[0],o=e[1],i=window.Math[r];window.BrowserMath[r]=i,window.Math[r]=["pow","atan2"].includes(r)?function(e,t){return Vt?o(e,t):i(e,t)}:function(e){return Vt?o(e):i(e)}},t=0,n=Object.entries(window.CroquetMath);t<n.length;t++)e()}}}]),x.default(e,[{key:"registerModel",value:function(e,t){if(Vt!==this)throw Error("Island Error");return t||(t=this.id+"/M"+ ++this.modelsId),this.modelsById[t]=e,t}},{key:"deregisterModel",value:function(e){if(Vt!==this)throw Error("Island Error");var t=this.modelsById;delete this.modelsById[e];for(var n=0,r=Object.entries(this.modelsByName);n<r.length;n++){var o=k.default(r[n],2),i=o[0];t===o[1]&&delete this.modelsByName[i]}this.messages.removeMany((function(t){return t.hasReceiver(e)}))}},{key:"lookUpModel",value:function(e){if(e===this.id)return this;var t=this.modelsById[e];if(t)return t;var n=e.match(/^([^#]+)#(.*)$/),r=k.default(n,3),o=(r[0],r[1]),i=r[2];return this.modelsById[o].lookUp(i)}},{key:"get",value:function(e){return this.modelsByName[e]}},{key:"set",value:function(e,t){if(Vt!==this)throw Error("Island Error");this.modelsByName[e]=t}},{key:"getNextTuttiSeq",value:function(){return this.tuttiSeq=this.tuttiSeq+1>>>0,this.tuttiSeq}},{key:"callModelMethod",value:function(e,t,n){if(Vt)throw Error("Island Error");var r=this.lookUpModel(e);if(r){var o=new rn(this.time,0,r.id,t,n);this.controller.sendMessage(o)}else console.error(Error("Model not found: ".concat(e)))}},{key:"noop",value:function(){}},{key:"generateJoinExit",value:function(e){var t=e.entered,n=e.exited,r=e.count;t.length===r&&(n=Object.keys(this.users));var o,i=zt(n);try{for(i.s();!(o=i.n()).done;){var a=o.value;if(this.users[a]){if(this.users[a].ignoreExit){this.users[a].ignoreExit--,console.warn("view ".concat(a," exited after joining twice, ignoring"));continue}delete this.users[a],this.publishFromModelOnly(this.id,"view-exit",a)}else console.error("view ".concat(a," exited without being present - this should not happen"))}}catch(e){i.e(e)}finally{i.f()}var s,u=zt(t);try{for(u.s();!(s=u.n()).done;){var c=s.value;this.users[c]?(console.warn("view ".concat(c," joined but already present, ignoring")),this.users[c].ignoreExit=(this.users[c].ignoreExit||0)+1):(this.users[c]={},this.publishFromModelOnly(this.id,"view-join",c))}}catch(e){u.e(e)}finally{u.f()}}},{key:"scheduleExternalMessage",value:function(e){var t=rn.fromState(e,this);if(t.time<this.time)throw Error("past message from reflector "+e);var n=this.externalSeq+1>>>0;if(t.seq!==n)throw Error("External message error. Expected message #".concat(n," got #").concat(t.seq));return this.externalTime=t.time,this.externalSeq=t.seq,t.seq=2*t.seq+1,this.messages.add(t),t}},{key:"futureSend",value:function(e,t,n,r){if(e.every)return this.futureRepeat(e.every,t,n,r);if(e<0)throw Error("attempt to send future message into the past");this.futureSeq=this.futureSeq+1>>>0;var o=new rn(this.time+e,2*this.futureSeq,t,n,r);return this.messages.add(o),o}},{key:"futureRepeat",value:function(e,t,n,r){this.futureSend(e,this.id,"futureExecAndRepeat",[e,t,n,r])}},{key:"futureExecAndRepeat",value:function(e,t,n,r){var o=this.lookUpModel(t);if("function"==typeof o[n])try{o[n].apply(o,E.default(r))}catch(e){gt("future message ".concat(o,".").concat(n),e)}else{var i=Kt(n,o);try{i.apply(void 0,E.default(r))}catch(e){gt("future message ".concat(o," ").concat(i),e)}}this.futureRepeat(e,t,n,r)}},{key:"future",value:function(e,t,n,r){var o=this.asQFunc(e,n);if("string"==typeof o)return this.futureSend(t,e.id,o,r);var i=this;return new Proxy(e,{get:function(n,r){if("function"==typeof e[r])return function(){if(i.lookUpModel(e.id)!==e)throw Error("future send to unregistered model");for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return i.futureSend(t,e.id,r,o)};throw Error("Tried to call "+r+"() on future of "+Object.getPrototypeOf(e).constructor.name+" which is not a function")}})}},{key:"advanceTo",value:function(e,t){if(Vt)throw Error("Island Error");for(var n,r=0;(n=this.messages.peek())&&n.time<=e;){var o=n,i=o.time,a=o.seq;if(i<this.time)throw Error("past message encountered: "+n);if(1&a&&(this.seq=this.seq+1>>>0,a/2>>>0!==this.seq))throw Error("Sequence error: expected ".concat(this.seq," got ").concat(a/2>>>0," in ").concat(n));if(this.messages.poll(),this.time=n.time,n.executeOn(this),++r>100&&(r=0,Date.now()>t))return!1}return this.time=e,!0}},{key:"asQFunc",value:function(e,t){if("string"==typeof t)return t;if("function"==typeof t){if(e[t.name]===t)return t.name;for(var n=e;null!==n;){for(var r=0,o=Object.entries(Object.getOwnPropertyDescriptors(n));r<o.length;r++){var i=k.default(o[r],2),a=i[0];if(i[1].value===t)return a}n=Object.getPrototypeOf(n)}var s=t.toString().match(/^\(?([a-z][a-z0-9]*)?\)? *=> *this\.([a-z][a-z0-9]*) *\( *([a-z][a-z0-9]*)? *\) *$/i);return!s||s[3]&&s[3]!==s[1]?function(e,t){"function"==typeof e&&(t=e,e={});var n=Object.keys(e).concat(["return "+t]),r=Object.values(e),o={qPara:n,qArgs:r},i=r.indexOf(t);return i>=0&&(r[i]=n[i],o.qFn=i),"{".concat(btoa(JSON.stringify(o)),"}")}(t):s[2]}return null}},{key:"addSubscription",value:function(e,t,n,r){if(Vt!==this)throw Error("Island Error");var o=this.asQFunc(e,r);if("string"!=typeof o)throw Error('Subscription handler for "'.concat(n,'" must be a method name'));if("function"!=typeof e[o]&&"{"!==o[0])throw Error('Subscriber method for "'.concat(n,'" not found: ').concat(e,".").concat(o,"()"));var i=t+":"+n,a=e.id+"."+o;if(this.subscriptions[i]){if(-1!==this.subscriptions[i].indexOf(a))throw Error("".concat(e,".").concat(o," already subscribed to ").concat(n))}else this.subscriptions[i]=[];this.subscriptions[i].push(a)}},{key:"removeSubscription",value:function(e,t,n,r){if(Vt!==this)throw Error("Island Error");var o=t+":"+n,i=e.id+"."+r,a=this.subscriptions[o];if(a){var s=a.indexOf(i);a.splice(s,1),0===a.length&&delete this.subscriptions[o]}}},{key:"removeAllSubscriptionsFor",value:function(e){for(var t="".concat(e.id,":"),n="".concat(e.id,"."),r=0,o=Object.entries(this.subscriptions);r<o.length;r++){var i=k.default(o[r],2),a=i[0],s=i[1];if(a.startsWith(t))delete this.subscriptions[a];else{for(var u=s.length-1;u>=0;u--)s[u].startsWith(n)&&s.splice(u,1);0===s.size&&delete this.subscriptions[a]}}}},{key:"publishFromModel",value:function(e,t,n){if(Vt!==this)throw Error("Island Error");var r=t.endsWith("#reflected");r&&(t=t.slice(0,t.length-"#reflected".length));var o=e+":"+t;this.handleModelEventInModel(o,n,r),this.handleModelEventInView(o,n)}},{key:"publishFromModelOnly",value:function(e,t,n){if(Vt!==this)throw Error("Island Error");var r=e+":"+t;this.handleModelEventInModel(r,n)}},{key:"publishFromView",value:function(e,t,n){if(Vt)throw Error("Island Error");var r=e+":"+t;this.handleViewEventInModel(r,n),this.handleViewEventInView(r,n)}},{key:"handleModelEventInModel",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(Vt!==this)throw Error("Island Error");if(n){var r=this.getNextTuttiSeq();if(!0!==this.controller.synced)return;var o=e+"#__vote",i=e+"#divergence",a=!!Dt.subscriptions[o],s=!!this.subscriptions[e],u=!!this.subscriptions[i];a&&u&&console.log("divergence subscription for ".concat(e," overridden by vote subscription"));var c,l=s?new rn(this.time,0,this.id,"handleModelEventInModel",[e,t]):null;c=a?[this.id,"handleModelEventInView",o]:[this.id,"handleTuttiDivergence",i],this.controller.sendTutti(this.time,r,t,l,a,c)}else if(this.subscriptions[e]){var f,h=zt(this.subscriptions[e]);try{for(h.s();!(f=h.n()).done;){var d=f.value,p=d.split("."),v=L.default(p),y=v[0],m=v.slice(1),g=m.join("."),w=this.lookUpModel(y);if(w){if("{"===g[0]){var b=Kt(g,w);try{b(t)}catch(t){gt("event ".concat(e," ").concat(w," ").concat(b),t)}continue}"function"!=typeof w[g]&&yt("event ".concat(e," ").concat(w,".").concat(g,"(): method not found"))}else yt("event ".concat(e," .").concat(g,"(): subscriber not found"));try{w[g](t)}catch(t){gt("event ".concat(e," ").concat(w,".").concat(g,"()"),t)}}}catch(e){h.e(e)}finally{h.f()}}}},{key:"handleViewEventInModel",value:function(e,t){if(this.subscriptions[e]){var n=new rn(this.time,0,this.id,"handleModelEventInModel",[e,t]);this.controller.sendMessage(n)}}},{key:"handleModelEventInView",value:function(e,t){var n=this;Dt.handleEvent(e,t,(function(e){return function(e){if(!Vt)throw Error("Island confusion");var t=Vt;try{Vt=null,e()}finally{Vt=t}}((function(){return $t(n,e,!0)}))}))}},{key:"handleViewEventInView",value:function(e,t){Dt.handleEvent(e,t)}},{key:"handleTuttiDivergence",value:function(e,t){if(this.subscriptions[e])this.handleModelEventInModel(e,t);else{var n=e.split(":").slice(-1)[0];console.warn("uncaptured divergence in ".concat(n,":"),t)}}},{key:"processModelViewEvents",value:function(){var e=this;if(Vt)throw Error("Island Error");return $t(this,(function(){return Dt.processFrameEvents(!!e.controller.synced)}))}},{key:"pollToCheckSync",value:function(){var e=this.getNextTuttiSeq();if(!0===this.controller.synced){var t=Date.now(),n={date_island:this.time,hash:this.getSummaryHash()},r=Date.now()-t;this.controller.cpuTime-=r;var o=[this.id,"handleSyncCheckVote","syncCheckVote"];this.controller.sendTutti(this.time,e,n,null,!0,o)}}},{key:"handleSyncCheckVote",value:function(e,t){this.controller.handleSyncCheckVote(t)}},{key:"pollForSnapshot",value:function(){var e=this,t=this.getNextTuttiSeq(),n=this.time,r=n-this.lastSnapshotPoll;if(r<5e3)console.log("rejecting snapshot poll ".concat(r,"ms after previous"));else{this.lastSnapshotPoll=n;var o=this.controller.preparePollForSnapshot();if(o){var i=Date.now();o.hash=this.getSummaryHash();var a=Date.now()-i;this.controller.cpuTime-=a,Promise.resolve().then((function(){return e.controller.pollForSnapshot(n,t,o)}))}}}},{key:"handleSnapshotVote",value:function(e,t){this.controller.handleSnapshotVote(t)}},{key:"snapshot",value:function(){return sn.newOrRecycled(this).snapshot(this,"$")}},{key:"getSummaryHash",value:function(){return A.default((new an).getHash(this))}},{key:"random",value:function(){if(Vt!==this)throw Error("Island Error");return this._random()}},{key:"randomID",value:function(){if(Vt!==this)throw Error("Island Error");for(var e="",t=0;t<4;t++)e+=(this._random.int32()>>>0).toString(16).padStart(8,"0");return e}}]),e}();function Xt(e,t,n){n.length>0&&(n=cn.newOrRecycled().encode(n));return"".concat(e,">").concat(t).concat(n.length>0?JSON.stringify(n):"")}function Zt(e,t){var n=e.match(/^([^[]+)(\[.*)?$/i),r=k.default(n,3),o=(r[0],r[1]),i=r[2],a=o.split(">"),s=k.default(a,2),u=s[0],c=s[1],l=[];i&&(l=ln.newOrRecycled(t).decode(JSON.parse(i)));return{receiver:u,selector:c,args:l}}function en(e,t){return(t-e|0)>=0}var tn,nn,rn=function(){function e(t,n,r,o,i){S.default(this,e),this.time=t,this.seq=n,this.receiver=r,this.selector=o,this.args=i}return x.default(e,[{key:"convertIfNeeded",value:function(e){if(this.payload){var t=Zt(this.payload,e),n=t.receiver,r=t.selector,o=t.args;delete this.payload,this.receiver=n,this.selector=r,this.args=o}return this}},{key:"before",value:function(e){return this.time!==e.time?this.time<e.time:this.isExternal()!==e.isExternal()?e.isExternal():this.isExternal()?en(this.externalSeq,e.externalSeq):en(this.internalSeq,e.internalSeq)}},{key:"hasReceiver",value:function(e){return this.receiver===e}},{key:"isExternal",value:function(){return 1&this.seq}},{key:"asState",value:function(){return[this.time,this.seq,Xt(this.receiver,this.selector,this.args)]}},{key:"executeOn",value:function(e){var t=this,n=this.receiver,r=this.selector,o=this.args,i=e.lookUpModel(n);if(i)if("{"===r[0]){var a=Kt(r,i);Qt(e,(function(){Ht(e,(function(){try{a.apply(void 0,E.default(o))}catch(e){gt("".concat(t.shortString()," ").concat(a),e)}}))}))}else"function"!=typeof i[r]?yt("".concat(this.shortString()," ").concat(i,".").concat(r,"(): method not found")):Qt(e,(function(){Ht(e,(function(){try{i[r].apply(i,E.default(o))}catch(e){gt("".concat(t.shortString()," ").concat(i,".").concat(r,"()"),e)}}))}));else yt("".concat(this.shortString()," ").concat(r,"(): receiver not found"))}},{key:"shortString",value:function(){return"".concat(this.isExternal()?"External":"Future","Message")}},{key:"toString",value:function(){var e=this.receiver,t=this.selector,n=this.args,r=this.isExternal(),o=r?this.externalSeq:this.internalSeq;return"".concat(r?"External":"Future","Message[").concat(this.time).concat(":#"[+r]).concat(o," ").concat(e,".").concat(t,"(").concat(n.map(JSON.stringify).join(", "),")]")}},{key:Symbol.toPrimitive,value:function(){return this.toString()}},{key:"externalSeq",get:function(){return this.seq/2>>>0},set:function(e){this.seq=2*e+1}},{key:"internalSeq",get:function(){return this.seq/2>>>0},set:function(e){this.seq=2*e}}],[{key:"fromState",value:function(t,n){var r=k.default(t,3),o=r[0],i=r[1],a=Zt(r[2],n);return new e(o,i,a.receiver,a.selector,a.args)}}]),e}(),on=(tn=new ArrayBuffer(8),nn=new DataView(tn),function(e){return nn.setFloat64(0,e,!0),nn.getInt32(0,!0)+nn.getInt32(4,!0)}),an=function(){function e(){S.default(this,e),this.refs=new Map,this.todo=[],this.hashers=new Map,this.addHasher("Teatime:Message",rn);var t,n=zt(mn.allClassTypes());try{for(n.s();!(t=n.n()).done;){var r=k.default(t.value,2),o=r[0],i=r[1];this.addHasher(o,i)}}catch(e){n.e(e)}finally{n.f()}}return x.default(e,[{key:"addHasher",value:function(e,t){var n=this,r=Object.getPrototypeOf(t)===Object.prototype?t:{cls:t,write:function(e){return Object.assign({},e)}},o=r.cls,i=r.write;this.hashers.set(o,(function(e){return n.hashStructure(e,i(e))}))}},{key:"getHash",value:function(e){this.hashState={oC:0,mC:0,nanC:0,infC:0,zC:0,nC:0,nH:0,sC:0,sL:0,fC:0};for(var t=0,n=Object.entries(e);t<n.length;t++){var r=k.default(n[t],2),o=r[0],i=r[1];if("controller"!==o&&"meta"!==o)if("_random"===o)this.hash(i.state(),!1);else if("messages"===o){var a=i.asArray();(this.hashState.fC=a.length)&&this.hash(a,!1)}else this.hashEntry(o,i)}return this.hashDeferred(),this.hashState}},{key:"hashDeferred",value:function(){for(;this.todo.length>0;){var e=this.todo.shift(),t=e.key,n=e.value;this.hashEntry(t,n,!1)}}},{key:"hash",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];switch(C.default(e)){case"number":return void(Number.isNaN(e)?this.hashState.nanC++:Number.isFinite(e)?0===e?this.hashState.zC++:(this.hashState.nC++,this.hashState.nH+=on(e)):this.hashState.infC++);case"string":return this.hashState.sC++,void(this.hashState.sL+=e.length);case"boolean":case"undefined":return;default:var n=Object.prototype.toString.call(e).slice(8,-1);switch(n){case"Array":return void this.hashArray(e,t);case"Set":case"Map":case"Uint8Array":case"Uint16Array":case"Float32Array":return void this.hashStructure(e,E.default(e));case"Object":if(e instanceof mn)this.hashModel(e);else if(e.constructor===Object)this.hashObject(e,t);else{var r=this.hashers.get(e.constructor);if(!r)throw Error("Don't know how to hash ".concat(e.constructor.name));r(e)}return;case"Null":return;default:throw Error("Don't know how to hash ".concat(n))}}}},{key:"hashModel",value:function(e){if(!this.refs.has(e)){this.hashState.mC++,this.refs.set(e,!0);for(var t=0,n=Object.entries(e);t<n.length;t++){var r=k.default(n[t],2),o=r[0],i=r[1];"__realm"!==o&&(void 0!==i&&this.hashEntry(o,i))}}}},{key:"hashObject",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.refs.has(e)){this.hashState.oC++,this.refs.set(e,!0);for(var n=0,r=Object.entries(e);n<r.length;n++){var o=k.default(r[n],2),i=o[0],a=o[1];void 0!==a&&this.hashEntry(i,a,t)}}}},{key:"hashArray",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.refs.has(e)){this.refs.set(e,!0);for(var n=0;n<e.length;n++)this.hashEntry(n,e[n],t)}}},{key:"hashStructure",value:function(e,t){void 0!==t&&(this.refs.has(e)||(this.refs.set(e,!0),this.hash(t,!1)))}},{key:"hashEntry",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];"$"!==e[0]?n&&"object"===C.default(t)?this.todo.push({key:e,value:t}):this.hash(t):yt("hash: ignoring property ".concat(e),{only:"once"})}}]),e}(),sn=function(){function e(t){S.default(this,e),this.island=t,this.nextRef=1,this.refs=new Map,this.todo=[],this.writers=new Map,this.addWriter("Teatime:Message",rn);var n,r=zt(mn.allClassTypes());try{for(r.s();!(n=r.n()).done;){var o=k.default(n.value,2),i=o[0],a=o[1];this.addWriter(i,a)}}catch(e){r.e(e)}finally{r.f()}}return x.default(e,null,[{key:"newOrRecycled",value:function(e){var t=this.reusableInstance;return t?(t.island=e,t.nextRef=1,t.refs=new Map,t.todo=[]):t=this.reusableInstance=new this(e),t}},{key:"resetInstance",value:function(){this.reusableInstance=null}},{key:"reusableInstance",get:function(){return this[this.name+"-instance"]},set:function(e){this[this.name+"-instance"]=e}}]),x.default(e,[{key:"addWriter",value:function(e,t){var n=this,r=Object.getPrototypeOf(t)===Object.prototype?t:{cls:t,write:function(e){return Object.assign({},e)}},o=r.cls,i=r.write;this.writers.set(o,(function(t,r){return n.writeAs(e,t,i(t),r)}))}},{key:"snapshot",value:function(e){for(var t={_random:e._random.state(),messages:this.write(e.messages.asArray())},n=0,r=Object.entries(e);n<r.length;n++){var o=k.default(r[n],2),i=o[0],a=o[1];"controller"!==i&&(t[i]||this.writeInto(t,i,a,"$"))}return this.writeDeferred(),t}},{key:"writeDeferred",value:function(){for(;this.todo.length>0;){var e=this.todo.shift(),t=e.state,n=e.key,r=e.value,o=e.path;this.writeInto(t,n,r,o,!1)}}},{key:"write",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];switch(C.default(e)){case"number":return Object.is(e,-0)?{$class:"NegZero"}:Number.isSafeInteger(e)?e:Number.isNaN(e)?{$class:"NaN"}:Number.isFinite(e)?this.writeFloat(e):{$class:"Infinity",$value:Math.sign(e)};case"string":case"boolean":case"undefined":return e;default:var r=Object.prototype.toString.call(e).slice(8,-1);switch(r){case"Array":return this.writeArray(e,t,n);case"Set":case"Map":case"Uint8Array":case"Uint16Array":case"Float32Array":return this.writeAs(r,e,E.default(e),t);case"Object":if(e instanceof mn)return this.writeModel(e,t);if(e.constructor===Object)return this.writeObject(e,t,n);var o=this.writers.get(e.constructor);if(o)return o(e,t);throw Error("Don't know how to write ".concat(e.constructor.name," at ").concat(t));case"Null":return e;default:throw Error("Don't know how to write ".concat(r," at ").concat(t))}}}},{key:"writeModel",value:function(e,t){if(this.refs.has(e))return this.writeRef(e);var n={$model:mn.classToID(e.constructor)};this.refs.set(e,n);var r,o=zt(Object.keys(e).sort());try{for(o.s();!(r=o.n()).done;){var i=r.value;if("__realm"!==i){var a=e[i];void 0!==a&&this.writeInto(n,i,a,t)}}}catch(e){o.e(e)}finally{o.f()}return n}},{key:"writeObject",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.refs.has(e))return this.writeRef(e);var r={};this.refs.set(e,r);var o,i=zt(Object.keys(e).sort());try{for(i.s();!(o=i.n()).done;){var a=o.value,s=e[a];void 0!==s&&this.writeInto(r,a,s,t,n)}}catch(e){i.e(e)}finally{i.f()}return r}},{key:"writeArray",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.refs.has(e))return this.writeRef(e);var r=[];this.refs.set(e,r);for(var o=0;o<e.length;o++)this.writeInto(r,o,e[o],t,n);return r}},{key:"writeFloat",value:function(e){return e}},{key:"writeAs",value:function(e,t,n,r){if(void 0===n)return n;if(this.refs.has(t))return this.writeRef(t);var o={$class:e};this.refs.set(t,o);var i=this.write(n,r,!1);return"object"!==C.default(i)||i.$class||Array.isArray(i)?o.$value=i:Object.assign(o,i),o}},{key:"writeRef",value:function(e){var t=this.refs.get(e);if("object"!==C.default(t))throw Error("Non-object in refs: "+e);return Array.isArray(t)&&(t.toJSON=function(){return{$id:this.$id,$class:"Array",$value:E.default(this)}}),{$ref:t.$id||(t.$id=this.nextRef++)}}},{key:"writeInto",value:function(e,t,n,r){var o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if("$"!==t[0])if(o&&"object"===C.default(n))this.todo.push({state:e,key:t,value:n,path:r});else{var i="string"==typeof t&&t.match(/^[_a-z][_a-z0-9]*$/i),a=r+(i?".".concat(t):"[".concat(JSON.stringify(t),"]")),s=this.write(n,a);void 0!==s&&(e[t]=s)}else yt("snapshot: ignoring property ".concat(t),{only:"once"})}}]),e}(),un=function(){function e(t){S.default(this,e),this.island=t,this.refs=new Map,this.todo=[],this.unresolved=[],this.readers=new Map,this.addReader("Teatime:Message",rn);var n,r=zt(mn.allClassTypes());try{for(r.s();!(n=r.n()).done;){var o=k.default(n.value,2),i=o[0],a=o[1];this.addReader(i,a)}}catch(e){r.e(e)}finally{r.f()}this.readers.set("NaN",(function(){return NaN})),this.readers.set("Infinity",(function(e){return e*(1/0)})),this.readers.set("NegZero",(function(){return-0})),this.readers.set("Set",(function(e){return new Set(e)})),this.readers.set("Map",(function(e){return new Map(e)})),this.readers.set("Array",(function(e){return e.slice(0)})),this.readers.set("Uint8Array",(function(e){return new Uint8Array(e)})),this.readers.set("Uint16Array",(function(e){return new Uint16Array(e)})),this.readers.set("Float32Array",(function(e){return new Float32Array(e)}))}return x.default(e,null,[{key:"newOrRecycled",value:function(e){var t=this.reusableInstance;return t?(t.island=e,t.refs=new Map,t.todo=[],t.unresolved=[]):t=this.reusableInstance=new this(e),t}},{key:"resetInstance",value:function(){this.reusableInstance=null}},{key:"reusableInstance",get:function(){return this[this.name+"-instance"]},set:function(e){this[this.name+"-instance"]=e}}]),x.default(e,[{key:"addReader",value:function(e,t){var n="object"===C.default(t)?t.read:function(e){return Object.assign(Object.create(t.prototype),e)};this.readers.set(e,n)}},{key:"readIsland",value:function(e,t){if("$"!==t)throw Error("Island must be root object");for(var n={_random:new I.default(null,{state:e._random})},r=0,o=Object.entries(e);r<o.length;r++){var i=k.default(o[r],2),a=i[0],s=i[1];n[a]||this.readInto(n,a,s,t)}return this.readDeferred(),this.resolveRefs(),n}},{key:"readDeferred",value:function(){for(;this.todo.length>0;){var e=this.todo.shift(),t=e.object,n=e.key,r=e.value,o=e.path;this.readInto(t,n,r,o,1)}}},{key:"resolveRefs",value:function(){var e,t=zt(this.unresolved);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=n.object,o=n.key,i=n.ref,a=n.path;if(!this.refs.has(i))throw Error("Unresolved ref: ".concat(i," at ").concat(a,"[").concat(JSON.stringify(o),"]"));r[o]=this.refs.get(i)}}catch(e){t.e(e)}finally{t.f()}}},{key:"read",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;switch(C.default(e)){case"number":case"string":case"boolean":return e;default:var r=Object.prototype.toString.call(e).slice(8,-1);switch(r){case"Array":return this.readArray(e,t,n);case"Null":return null;case"Object":var o=e.$class,i=e.$model,a=e.$ref;if(a)throw Error("refs should have been handled in readInto()");return i?this.readModel(e,t):o?this.readAs(o,e,t):this.readObject(Object,e,t,n);default:throw Error("Don't know how to read ".concat(r," at ").concat(t))}}}},{key:"readModel",value:function(e,t){var n=mn.instantiateClassID(e.$model,e.id);e.$id&&this.refs.set(e.$id,n);for(var r=0,o=Object.entries(e);r<o.length;r++){var i=k.default(o[r],2),a=i[0],s=i[1];"id"!==a&&"$"!==a[0]&&this.readInto(n,a,s,t)}return n}},{key:"readObject",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=new e;t.$id&&this.refs.set(t.$id,o);for(var i=0,a=Object.entries(t);i<a.length;i++){var s=k.default(a[i],2),u=s[0],c=s[1];"$"!==u[0]&&this.readInto(o,u,c,n,r)}return o}},{key:"readArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=[];e.$id&&this.refs.set(e.$id,r);for(var o=0;o<e.length;o++)void 0!==e[o]&&this.readInto(r,o,e[o],t,n);return r}},{key:"readAs",value:function(e,t,n){var r={},o=new Map;if("$value"in t)r=this.read(t.$value,n,2);else for(var i=0,a=Object.entries(t);i<a.length;i++){var s=k.default(a[i],2),u=s[0],c=s[1];if("$"!==u[0]){var l=c&&c.$ref;l?this.refs.has(l)?r[u]=this.refs.get(l):(r[u]="<unresolved>",o.set(l,u)):this.readInto(r,u,c,n,1)}}var f=this.readers.get(e)(r,n);f||"NaN"===e||console.warn('Reading "'.concat(e,'" returned ').concat(f," at ").concat(n)),t.$id&&this.refs.set(t.$id,f);var h,d=zt(o.entries());try{for(d.s();!(h=d.n()).done;){var p=k.default(h.value,2),v=p[0],y=p[1];this.unresolved.push({object:f,key:y,ref:v,path:n})}}catch(e){d.e(e)}finally{d.f()}return f}},{key:"readRef",value:function(e,t,n,r){if(!n||!n.$ref)return!1;var o=n.$ref;return this.refs.has(o)?e[t]=this.refs.get(o):(e[t]="<unresolved>",this.unresolved.push({object:e,key:t,ref:o,path:r})),!0}},{key:"readInto",value:function(e,t,n,r){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!this.readRef(e,t,n,r))if(0!==o||"object"!==C.default(n)){var i="string"==typeof t&&t.match(/^[_a-z][_a-z0-9]*$/i),a=r+(i?".".concat(t):"[".concat(JSON.stringify(t),"]"));e[t]=this.read(n,a,o>0?o-1:0)}else this.todo.push({object:e,key:t,value:n,path:r})}}]),e}(),cn=function(e){j.default(n,e);var t=Jt(n);function n(){return S.default(this,n),t.apply(this,arguments)}return x.default(n,[{key:"encode",value:function(e){var t=this.writeArray(e,"$");return this.writeDeferred(),t}},{key:"writeModel",value:function(e){return{$ref:e.id}}}]),n}(sn),ln=function(e){j.default(n,e);var t=Jt(n);function n(){return S.default(this,n),t.apply(this,arguments)}return x.default(n,[{key:"decode",value:function(e){var t=this.readArray(e,"$");return this.readDeferred(),this.resolveRefs(),t}},{key:"resolveRefs",value:function(){var e,t=zt(this.unresolved);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=n.object,o=n.key,i=n.ref,a=n.path;if(this.refs.has(i))r[o]=this.refs.get(i);else{var s=this.island.lookUpModel(i);if(!s)throw Error("Unresolved ref: ".concat(i," at ").concat(a,"[").concat(JSON.stringify(o),"]"));r[o]=s}}}catch(e){t.e(e)}finally{t.f()}}}]),n}(un);function fn(){un.resetInstance(),sn.resetInstance(),cn.resetInstance(),ln.resetInstance()}function hn(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return dn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return dn(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function dn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var pn=Y.has("debug","classes",!1),vn=Symbol("SECRET"),yn=new WeakSet,mn=function(){function e(t){if(S.default(this,e),t!==vn)throw Error("You must create ".concat(this,' using create() not "new"!'))}return x.default(e,null,[{key:"__isTeatimeModelClass__",value:function(){return!0}},{key:"create",value:function(t,n){var r=Ft(),o=new this(vn);return Object.defineProperty(o,"__realm",{value:r}),Object.defineProperty(o,"id",{value:r.register(o),enumerable:!0}),yn.add(o),n&&o.beWellKnownAs(n),o.init(t),yn.has(o)&&(yn.delete(o),Object.getPrototypeOf(this)!==e&&console.warn("".concat(o," did not call super.init(options)"))),o}},{key:"createNoInit",value:function(e){var t=Ft(),n=new this(vn);return Object.defineProperty(n,"__realm",{value:t}),Object.defineProperty(n,"id",{value:e,enumerable:!0}),n}},{key:"allowConstructors",value:function(){vn=void 0,console.warn("disabling error reporting for Model constructors")}},{key:"register",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"unknown-file";return fn(),Oe(this),En(e,this.name,this),this}},{key:"registerIfNeeded",value:function(){Sn(this)||this.register()}},{key:"types",value:function(){return{}}},{key:"classToID",value:function(e){return function(e){if(Sn(e))return e[wn];if(bn(),Sn(e))return e[wn];throw Error('Class "'.concat(e.name,'" not found, did you call ').concat(e.name,".register()?"))}(e)}},{key:"classFromID",value:function(e){return xn(e)}},{key:"allClasses",value:function(){return kn()}},{key:"allClassTypes",value:function(){return function(){var e,t={},n=hn(kn());try{for(n.s();!(e=n.n()).done;){var r=e.value;Object.prototype.hasOwnProperty.call(r,"types")&&Object.assign(t,r.types())}}catch(e){n.e(e)}finally{n.f()}return Object.entries(t)}()}},{key:"instantiateClassID",value:function(e,t){return xn(e).createNoInit(t)}}]),x.default(e,[{key:"init",value:function(e){yn.delete(this)}},{key:"destroy",value:function(){Ft().unsubscribeAll(this),Ft().deregister(this)}},{key:"publish",value:function(e,t,n){this.__realm||this.__realmError(),this.__realm.publish(t,n,e)}},{key:"subscribe",value:function(e,t,n){return this.__realm||this.__realmError(),this.__realm.subscribe(this,e,t,n)}},{key:"unsubscribe",value:function(e,t){this.__realm||this.__realmError(),this.__realm.unsubscribe(this,e,t)}},{key:"unsubscribeAll",value:function(){this.__realm||this.__realmError(),this.__realm.unsubscribeAll(this)}},{key:"__realmError",value:function(){if(!this.id)throw Error("".concat(this," has no ID, did you call super.init(options)?"))}},{key:"future",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;this.__realm||this.__realmError();for(var n=arguments.length,r=new Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];return this.__realm.future(this,e,t,r)}},{key:"random",value:function(){return Ft().random()}},{key:"now",value:function(){return Ft().now()}},{key:"beWellKnownAs",value:function(e){Ft().island.set(e,this)}},{key:"wellKnownModel",value:function(e){return this.__realm.island.get(e)}},{key:"modelOnly",value:function(e){if(Yt.current()===this.__realm.island)return!0;var t=Error(e||"".concat(this,".modelOnly() called from outside a model!"));throw gt("view code",t),t}},{key:Symbol.toPrimitive,value:function(){var e=this.constructor.name;return e.includes("Model")?e:"".concat(e,"[Model]")}},{key:"sessionId",get:function(){return this.__realm.island.id}}]),e}(),gn={},wn=Symbol("CLASS_ID");function bn(){if(module.bundle)for(var e=0,t=Object.entries(module.bundle.cache);e<t.length;e++)for(var n=k.default(t[e],2),r=n[0],o=n[1],i=0,a=Object.entries(o.exports);i<a.length;i++){var s=k.default(a[i],2),u=s[0],c=s[1];c&&c.__isTeatimeModelClass__&&En(r,"default"===u?c.name:u,c)}}function kn(){return 0===Object.keys(gn).length&&bn(),Object.values(gn).map((function(e){return e.cls}))}function Sn(e){return Object.prototype.hasOwnProperty.call(e,wn)}function xn(e){if(gn[e])return gn[e].cls;if(bn(),gn[e])return gn[e].cls;throw Error('Class "'.concat(e,'" in snapshot, but not found in current source?'))}function En(e,t,n){var r="".concat(e,":").concat(t),o=gn[r];if(o&&o.cls!==n)throw Error("Duplicate class ".concat(t," in ").concat(e));return Sn(n)?pn&&!o&&console.warn("ignoring re-exported class ".concat(t," from ").concat(e)):(pn&&console.log("registering class ".concat(t," from ").concat(e)),n[wn]=r),gn[r]={cls:n,file:e},n}var Cn=function(){function e(t){S.default(this,e),Object.defineProperty(this,"realm",{value:Ft()}),Object.defineProperty(this,"id",{value:this.realm.register(this),configurable:!0})}return x.default(e,null,[{key:"displayStatus",value:function(e,t){return mt(e,t)}},{key:"displayWarning",value:function(e,t){return yt(e,t)}},{key:"displayError",value:function(e,t){return vt(e,t)}}]),x.default(e,[{key:"detach",value:function(){this.unsubscribeAll(),this.realm.deregister(this),Object.defineProperty(this,"id",{value:""})}},{key:"reattach",value:function(){Object.defineProperty(this,"id",{value:this.realm.register(this)})}},{key:"publish",value:function(e,t,n){this.realm.publish(t,n,e)}},{key:"subscribe",value:function(e,t,n){n=n.bind(this);var r=t.event?t:{event:t},o=r.event,i=r.handling;this.realm.subscribe(o,this.id,n,e,i)}},{key:"unsubscribe",value:function(e,t){this.realm.unsubscribe(t,this.id,null,e)}},{key:"unsubscribeAll",value:function(){this.realm.unsubscribeAll(this.id)}},{key:"future",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.realm.future(this,e)}},{key:"random",value:function(){return Ft().random()}},{key:"now",value:function(){return this.realm.now()}},{key:"externalNow",value:function(){return this.realm.externalNow()}},{key:"update",value:function(e){}},{key:"wellKnownModel",value:function(e){return this.realm.island.get(e)}},{key:"inSameViewRealm",value:function(e){return $t(this.realm.island,e,!0)}},{key:Symbol.toPrimitive,value:function(){var e=this.constructor.name;return e.includes("View")?e:"".concat(e,"[View]")}},{key:"sessionId",get:function(){return this.realm.island.id}},{key:"viewId",get:function(){return this.realm.island.controller.viewId}}]),e}();function On(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=N.default(e);if(t){var o=N.default(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return P.default(this,n)}}var Mn=Symbol("hash"),_n=new Map;function An(e,t){return Tn.apply(this,arguments)}function Tn(){return(Tn=_.default(M.default.mark((function e(t,n){return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n);case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function In(e,t){return qn.apply(this,arguments)}function qn(){return(qn=_.default(M.default.mark((function e(t,n){return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n);case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function jn(e){return Y.has("debug",e,!1)}function Pn(e,t){return"https://croquet.io/files/v1/sessiondata/".concat(t)}function Nn(e){return Dn.apply(this,arguments)}function Dn(){return(Dn=_.default(M.default.mark((function e(t){return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",de(t));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ln(e,t){return Rn.apply(this,arguments)}function Rn(){return(Rn=_.default(M.default.mark((function e(t,n){var r;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return jn("data")&&console.log("Uploading ".concat(n.byteLength," bytes to ").concat(t)),e.next=3,fetch(t,{method:"PUT",referrer:Tt.referrerURL(),body:n});case 3:if((r=e.sent).ok){e.next=6;break}throw Error("Croquet.Data: failed to upload ".concat(t," (").concat(r.status," ").concat(r.statusText,")"));case 6:jn("data")&&console.log("Croquet.Data: uploaded (".concat(r.status," ").concat(r.statusText,") ").concat(n.byteLength," bytes to ").concat(t));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Bn(e){return Un.apply(this,arguments)}function Un(){return(Un=_.default(M.default.mark((function e(t){var n;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return jn("data")&&console.log("Croquet.Data: Downloading from ".concat(t)),e.next=3,fetch(t,{referrer:Tt.referrerURL()});case 3:if(!(n=e.sent).ok){e.next=6;break}return e.abrupt("return",n.arrayBuffer());case 6:throw Error("Croquet.Data: failed to download ".concat(t," (").concat(n.status," ").concat(n.statusText,")"));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Fn=function(){var e,t;function n(e){S.default(this,n);var t=_n.get(e);if(t)return jn("data")&&console.log("Croquet.Data: using cached handle for ".concat(e)),t;Object.defineProperty(this,Mn,{value:e}),_n.set(e,this),jn("data")&&console.log("Croquet.Data: created new handle for ".concat(e))}return x.default(n,null,[{key:"store",value:(t=_.default(M.default.mark((function e(t,r){var o,i,a,s,u,c,l,f=arguments;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=f.length>2&&void 0!==f[2]&&f[2],!Yt.hasCurrent()){e.next=3;break}throw Error("Croquet.Data.store() called from Model code");case 3:return i=null,e.next=6,An(i,r);case 6:return a=e.sent,e.next=9,Nn(a);case 9:if(s=e.sent,u=new n(s),c=Pn(0,s),l=Ln(c,a),u.stored||Object.defineProperty(u,"stored",{value:function(){return Yt.hasCurrent()?void 0:l}}),o){e.next=17;break}return e.next=17,l;case 17:return e.abrupt("return",u);case 18:case"end":return e.stop()}}),e)}))),function(e,n){return t.apply(this,arguments)})},{key:"fetch",value:(e=_.default(M.default.mark((function e(t,n){var r,o,i;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Yt.hasCurrent()){e.next=2;break}throw Error("Croquet.Data.fetch() called from Model code");case 2:if("string"==typeof(r=n&&n[Mn])){e.next=5;break}throw Error("Croquet.Data.fetch() called with invalid handle");case 5:return o=Pn(0,r),e.next=8,Bn(o);case 8:return i=e.sent,e.abrupt("return",In(null,i));case 11:case"end":return e.stop()}}),e)}))),function(t,n){return e.apply(this,arguments)})}]),n}();function Hn(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return $n(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return $n(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function $n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Jn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function zn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Jn(Object(n),!0).forEach((function(t){O.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Jn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}(function(e){j.default(n,e);var t=On(n);function n(){return S.default(this,n),t.apply(this,arguments)}return x.default(n,null,[{key:"types",value:function(){return{"@croquet.data":{cls:Fn,write:function(e){return e[Mn]},read:function(e){return new Fn(e)}}}}}]),n})(mn).register();var Wn=H;console.log("Croquet SDK "+Wn);var Vn=window.location.hostname.match(/^(.*\.)?croquet\.io$/i)?window.location.host:"croquet.io",Gn="wss://".concat(Vn,"/reflector/v").concat(1),Kn=null;var Qn=Y.nocheat,Yn=["tps"];function Xn(){return Math.floor(Math.random()*Math.pow(36,10)).toString(36)}var Zn=new Set,er=function(){function e(){S.default(this,e),this.reset()}var t,n,r,o,i,a,s,u;return x.default(e,[{key:"reset",value:function(){window.ISLAND===this.island&&delete window.ISLAND,this.island=null,this.connection=this.connection||new tr(this),this.networkQueue=new qe,this.time=0,this.session="",this.key=null,this.viewId=this.viewId||Xn(),this.users=0,this.usersTotal=0,this.cpuTime=0,this.triggeringCpuTime=null,this.synced=null,this.latency=0,this.latencyHistory&&(this.latencyHistory=[]),this.localTicker&&(window.clearInterval(this.localTicker),delete this.localTicker),this.syncTimer&&(window.clearTimeout(this.syncTimer),delete this.syncTimer),this.tuttiHistory=[],Dt.removeAllSubscriptionsFor(this.viewId),Dt.addSubscription(this.viewId,"__users__",this.viewId,(function(e){return mt("users now ".concat(e.count))}),"oncePerFrameWhileSynced"),this.leaving||Tt.showSyncWait(!0)}},{key:"checkForConnection",value:function(e){this.connection.checkForConnection(e)}},{key:"dormantDisconnect",value:function(){this.connected&&this.connection.dormantDisconnect()}},{key:"establishSession",value:(u=_.default(M.default.mark((function e(t,n){var r,o,i,a,s,u,c,l,f,h,d,p,v,y,m,g,w,b,k,S,x,C;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(Kn={messages:Y.has("debug","messages",!1),sends:Y.has("debug","sends",!1),ticks:Y.has("debug","ticks",!1),pong:Y.has("debug","pong",!1),snapshot:Y.has("debug","snapshot",!1),session:Y.has("debug","session",!1),initsnapshot:Y.has("debug","initsnapshot","localhost"),reflector:Y.has("debug","reflector",Y.dev||"localhost")},r=n.optionsFromUrl,o=n.password,i=n.multiRoom,a=n.autoSession,s=n.login,u=zn({},n.options),c=0,l=[].concat(Yn,E.default(r||[]));c<l.length;c++)(f=l[c])in Y&&(u[f]=Y[f]);if(!s){e.next=7;break}return e.next=7,Z();case 7:return h=o||Y.pw||"THIS SHOULDN'T BE IN LOGS",d=B.default.PBKDF2(h,"",{keySize:8}),this.key=B.default.lib.WordArray.create(d.words.slice(0,8)),a&&(p=t,v=Y.getSession().split("/"),y=i?v[1]:v[0],m=i?v[2]:v[1],(g=!y||!m)&&(a.user&&(y=a.user),a.random&&(m=a.random),y||(y=X("name","").toLowerCase()||"GUEST"),m||(m=Xn())),this.session=i?"".concat(p,"/").concat(y,"/").concat(m):"".concat(y,"/").concat(m),i||(Y.setSession(this.session,g),Tt.sessionURL=window.location.href),t="".concat(p,"/").concat(y,"/").concat(m)),e.next=13,Me(t,u,Wn);case 13:return w=e.sent,b=w.id,k=w.sessionHash,S=w.codeHash,console.log('Session ID for "'.concat(t,'": ').concat(b)),this.islandCreator=zn(zn({},n),{},{options:u,name:t,sessionHash:k,codeHash:S}),x=!1,this.islandCreator.snapshot?this.islandCreator.snapshot.id!==b&&(C=this.islandCreator.snapshot.sessionHash===k,console.warn("Existing snapshot was for different ".concat(C?"code base":"session","!")),x=!0):x=!0,x&&(this.islandCreator.snapshot={id:b,time:0,meta:{id:b,sessionHash:k,codeHash:S,created:(new Date).toISOString()}}),e.next=24,this.join();case 24:return e.next=26,this.startedOrSynced();case 26:return e.abrupt("return",this.island.modelsByName);case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"lastKnownTime",value:function(e){return Math.max(e.time,e.externalTime)}},{key:"handleSyncCheckVote",value:function(e){if(!0===this.synced){var t=e._local,n=e.tally,r=Object.keys(n);t&&r.includes(t)?r.length>1?console.log(r):console.log("ok"):console.log(this.id,"Sync: local vote not found",t,n)}}},{key:"takeSnapshot",value:function(){var e=this.island.snapshot(),t=this.lastKnownTime(e),n=e.externalSeq;return e.meta=zn(zn({},this.islandCreator.snapshot.meta),{},{options:this.islandCreator.options,time:t,seq:n,date:(new Date).toISOString(),host:window.location.hostname,sdk:Wn}),delete e.meta.hash,e}},{key:"scheduleSnapshot",value:function(){if(this.island){var e=this.island.time,t=e-this.island.lastSnapshotPoll;if(t<5e3)Kn.snapshot&&console.log("not requesting snapshot poll (".concat(t,"ms since poll scheduled)"));else{var n=new rn(e,0,this.island.id,"pollForSnapshot",[]);this.sendTagged(n,{debounce:5e3,msgID:"pollForSnapshot"}),Kn.snapshot&&console.log(this.id,"Controller scheduling snapshot via reflector")}}}},{key:"preparePollForSnapshot",value:function(){var e=this.triggeringCpuTime||this.cpuTime;return this.triggeringCpuTime=null,this.cpuTime=0,!0===this.synced?{cpuTime:e}:null}},{key:"pollForSnapshot",value:function(e,t,n){n.cpuTime+=Math.random();var r=[this.id,"handleSnapshotVote","snapshotVote"];this.sendTutti(e,t,n,null,!0,r)}},{key:"handleSnapshotVote",value:function(e){var t=this;if(!0===this.synced){var n=e._local,r=e.tally,o=Object.keys(r);if(!n||!o.includes(n))return Kn.snapshot&&console.log(this.id,"Snapshot: local vote not found"),void(this.cpuTime=0);var i=o.map((function(e){return JSON.parse(e)})),a={};i.forEach((function(e,t){var n=e.hash;a[n]||(a[n]=[]),a[n].push(t)}));var s=Object.keys(a),u=s[0];s.length>1&&(console.warn(this.id,"Snapshots fall into ".concat(s.length," groups")),s.sort((function(e,t){return a[t].length-a[e].length})),a[s[0]].length===a[s[1]].length&&(Kn.snapshot&&console.log(this.id,"Deciding consensus by tie-break"),u=s[0]<s[1]?s[0]:s[1])),s.forEach((function(e){return function(e,r){var s=a[e];s.length>1&&s.sort((function(e,t){return i[e].cpuTime-i[t].cpuTime}));var u=s[0];if(o[u]===n){var c=r?null:{groupSize:s.length};t.serveSnapshot(c)}}(e,e===u)}))}else Kn.snapshot&&console.log("Ignoring snapshot vote during sync")}},{key:"serveSnapshot",value:function(e){var t=ot.begin("snapshot"),n=this.takeSnapshot(),r=ot.end("snapshot")-t;this.cpuTime-=r,Kn.snapshot&&console.log(this.id,"Snapshotting took ".concat(Math.ceil(r)," ms")),this.uploadSnapshot(n,e)}},{key:"snapshotUrl",value:function(e,t,n,r,o){var i,a="".concat(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"code",t=Y.has("dev","host","localhost")?"dev/".concat(X("name","GUEST"),"/"):"";return"".concat(ae(),"/").concat(t).concat(e,"/")}("snapshots")).concat(this.id),s=".json".concat(o?"."+o:""),u="".concat((i=Math.round(t),(""+i).padStart(10,"0")),"_").concat(n,"-").concat(e,"-").concat(r).concat(s);return"".concat(a,"/").concat(u)}},{key:"hashSnapshot",value:function(e){return e.meta.hash?e.meta.hash:(e.meta.hashPromise||(e.meta.hashPromise=new Promise((function(t){var n=zn({},e);delete n.meta,be(JSON.stringify(n)).then((function(n){e.meta.hash=n,delete e.meta.hashPromise,t(n)}))}))),e.meta.hashPromise)}},{key:"uploadSnapshot",value:(s=_.default(M.default.mark((function e(t){var n,r,o,i,a,s,u,c,l,f,h,d=arguments;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=d.length>1&&void 0!==d[1]?d[1]:null,e.next=3,this.hashSnapshot(t);case 3:return r=Date.now(),o=JSON.stringify(t),i=Date.now()-r,a=t.meta,s=a.time,u=a.seq,c=a.hash,l=this.snapshotUrl("snap",s,u,c,"gz"),Kn.snapshot&&console.log(this.id,"Controller uploading snapshot (".concat(o.length," bytes, ").concat(i,"ms) to ").concat(l)),f=this.connection.socket,e.next=12,this.uploadGzipped(l,o);case 12:if(h=e.sent,this.connection.socket===f){e.next=16;break}return console.error("Controller was reset while trying to upload snapshot"),e.abrupt("return",!1);case 16:if(h){e.next=19;break}return console.error("Failed to upload snapshot"),e.abrupt("return",!1);case 19:return this.announceSnapshotUrl(s,u,c,l,n),e.abrupt("return",!0);case 21:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"announceSnapshotUrl",value:function(e,t,n,r,o){if(Kn.snapshot){var i="time: ".concat(e,", seq: ").concat(t,", hash: ").concat(n);o&&(i+=", dissident: "+JSON.stringify(o)),console.log(this.id,"Controller sending snapshot url to reflector (".concat(i,"): ").concat(r))}try{this.connection.send(JSON.stringify({id:this.id,action:"SNAP",args:{time:e,seq:t,hash:n,url:r,dissident:o}}))}catch(e){console.error("ERROR while sending",e)}}},{key:"fetchJSON",value:(a=_.default(M.default.mark((function e(t,n){var r,o,i;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t,{mode:"cors",referrer:Tt.referrerURL()});case 3:if(r=e.sent,!t.endsWith(".gz")){e.next=10;break}return e.next=7,r.arrayBuffer();case 7:return o=e.sent,i=U.default.inflate(new Uint8Array(o),{to:"string"}),e.abrupt("return",JSON.parse(i));case 10:return e.next=12,r.json();case 12:return e.abrupt("return",e.sent);case 15:e.prev=15,e.t0=e.catch(0);case 17:return e.abrupt("return",n);case 18:case"end":return e.stop()}}),e,null,[[0,15]])}))),function(e,t){return a.apply(this,arguments)})},{key:"uploadJSON",value:(i=_.default(M.default.mark((function e(t,n){var r,o;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t,{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json"},referrer:Tt.referrerURL(),body:n});case 3:return r=e.sent,o=r.ok,e.abrupt("return",o);case 8:e.prev=8,e.t0=e.catch(0);case 10:return e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,8]])}))),function(e,t){return i.apply(this,arguments)})},{key:"uploadGzipped",value:(o=_.default(M.default.mark((function e(t,n){var r,o,i,a,s;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Date.now(),o=(new TextEncoder).encode(n),i=U.default.gzip(o,{level:1}),Kn.snapshot&&console.log("Snapshot gzipping took ".concat(Date.now()-r,"ms")),e.prev=4,e.next=7,fetch(t,{method:"PUT",mode:"cors",headers:{"Content-Type":"application/octet-stream"},referrer:Tt.referrerURL(),body:i});case 7:return a=e.sent,s=a.ok,e.abrupt("return",s);case 12:e.prev=12,e.t0=e.catch(4);case 14:return e.abrupt("return",!1);case 15:case"end":return e.stop()}}),e,null,[[4,12]])}))),function(e,t){return o.apply(this,arguments)})},{key:"convertReflectorMessage",value:function(e){var t=this.id,n="noop",r=[];switch(e[2].what){case"users":var o=e[2],i=o.joined,a=o.left,s=o.active,u=o.total;this.users=s,this.usersTotal=u;var c=this.id,l={entered:i||[],exited:a||[],count:s};t=this.id,n="publishFromModelOnly",r=[c,"__users__",l],Dt.handleEvent(this.viewId+":__users__",l);break;case"tally":var f=e[2],h=f.tuttiSeq,d=f.tally,p=f.tallyTarget,v={tuttiSeq:h,tally:d},y=this.tuttiHistory.find((function(e){return e.tuttiSeq===h}));y&&(v._local=y.payload);var m=k.default(p,3);t=m[0],n=m[1],r=[m[2],v]}var g=new rn(0,0,t,n,r);e[2]=g.asState()[2]}},{key:"receive",value:(r=_.default(M.default.mark((function e(t,n){var r,o,i,a,s,u,c,l,f,h,d,p,v,y,m,g,w=this;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.lastReceived=this.connection.lastReceived,e.t0=t,e.next="SYNC"===e.t0?4:"RECV"===e.t0?28:"TICK"===e.t0?37:"INFO"===e.t0?44:"REQU"===e.t0?47:"LEAVE"===e.t0?49:52;break;case 4:r=n.messages,o=n.url,i=n.time,Kn.session&&console.log(this.id,"Controller received SYNC: time ".concat(i,", ").concat(r.length," messages, ").concat(o)),a=Hn(r);try{for(a.s();!(s=a.n()).done;)u=s.value,c=null,"string"!=typeof u[2]?(this.convertReflectorMessage(u),c=u):(l=this.decrypt_payload(u[2]),c=[u[0],u[1],l.msgPayload,l.viewId,l.lastSent,n.latency]),Kn.messages&&console.log(this.id,"Controller received message in SYNC "+JSON.stringify(c)),c[1]>>>=0,this.networkQueue.put(c)}catch(e){a.e(e)}finally{a.f()}if(this.timeFromReflector(i),Kn.session&&console.log("".concat(this.id," fetching snapshot ").concat(o)),e.t1=o,!e.t1){e.next=15;break}return e.next=14,this.fetchJSON(o);case 14:e.t1=e.sent;case 15:if(f=e.t1,this.connected){e.next=19;break}return console.log(this.id,"socket went away during SYNC"),e.abrupt("return");case 19:if(!o||f){e.next=22;break}return this.connection.closeConnectionWithError("SYNC",Error("failed to fetch snapshot")),e.abrupt("return");case 22:return f&&(this.islandCreator.snapshot=f),this.install(),Kn.session&&console.log("".concat(this.id," fast forwarding from ").concat(Math.round(this.island.time)," to ").concat(i)),h=function e(){w.simulate(Date.now()+200)?(Kn.session&&console.log("".concat(w.id," fast forwarded to ").concat(Math.round(w.island.time))),w.islandCreator.startedOrSynced.resolve(w.island)):setTimeout(e,0)},setTimeout(h,0),e.abrupt("return");case 28:return Kn.messages&&console.log(this.id,"Controller received RECV "+JSON.stringify(n)),d=null,"string"!=typeof(p=n)[2]?(this.convertReflectorMessage(p),d=p):(v=this.decrypt_payload(p[2]),d=[p[0],p[1],v.msgPayload,v.viewId,v.lastSent,n.latency]),d[1]>>>=0,d[3]===this.viewId&&this.addToStatistics(d[4],this.lastReceived),this.networkQueue.put(d),this.timeFromReflector(d[0]),e.abrupt("return");case 37:if(this.island){e.next=39;break}return e.abrupt("return");case 39:return y="number"==typeof n?n:n.time,Kn.ticks&&console.log(this.id,"Controller received TICK "+y),this.timeFromReflector(y),this.tickMultiplier&&this.multiplyTick(y),e.abrupt("return");case 44:return m=n.msg,g=n.options,Tt.showMessage(m,g),e.abrupt("return");case 47:return this.cpuTime=1e4,e.abrupt("return");case 49:return console.log(this.id,"Controller received LEAVE"),this.leave(),e.abrupt("return");case 52:console.warn("Unknown action:",t,n);case 53:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"install",value:function(){Kn.session&&console.log("".concat(this.id," installing island"));var e=this.islandCreator,t=e.snapshot,n=e.init,r=e.options,o=new Yt(t,(function(){try{return n(r)}catch(e){throw gt("init",e),e}}));if(Kn.initsnapshot&&!t.modelsById){var i=JSON.stringify(o.snapshot());o=new Yt(JSON.parse(i),(function(){return n(r)}))}var a=this.lastKnownTime(o);this.time=Math.max(this.time,a),this.setIsland(o)}},{key:"setIsland",value:function(e){this.island=e,this.island.controller=this}},{key:"createCleanIsland",value:function(){var e=this.islandCreator,t=e.options,n=e.init,r={id:this.id};return new Yt(r,(function(){return n(t)}))}},{key:"join",value:(n=_.default(M.default.mark((function e(){var t,n,r,o;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.checkForConnection(!1),e.next=3,this.connection.connectionPromise;case 3:Zn.add(this),Kn.session&&console.log(this.id,"Controller sending JOIN"),t=this.getTickAndMultiplier(),n=t.tick,r=t.delay,o={name:this.islandCreator.name,version:1,user:this.viewId,ticks:{tick:n,delay:r},url:Tt.referrerURL(),codeHash:this.islandCreator.codeHash,sdk:Wn},this.connection.send(JSON.stringify({id:this.id,action:"JOIN",args:o}));case 8:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"startedOrSynced",value:(t=_.default(M.default.mark((function e(){var t=this;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){return t.islandCreator.startedOrSynced={resolve:e,reject:n}})));case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"leave",value:function(){this.connected&&(console.log(this.id,"Controller LEAVING session for ".concat(this.islandCreator.name)),this.connection.send(JSON.stringify({id:this.id,action:"LEAVING"})));var e=this.islandCreator.destroyerFn;if(this.reset(),Zn.delete(this),!this.islandCreator)throw Error("do not discard islandCreator!");e&&e()}},{key:"encrypt",value:function(e){var t=B.default.lib.WordArray.random(16),n=B.default.AES.encrypt(e,this.key,{iv:t,padding:B.default.pad.Pkcs7,mode:B.default.mode.CBC}),r=B.default.HmacSHA256(e,this.key);return{ciphertext:n.toString(),iv:t,hmac:r}}},{key:"decrypt",value:function(e,t,n){var r=B.default.AES.decrypt(e,this.key,{iv:t}),o=B.default.HmacSHA256(B.default.enc.Utf8.stringify(r),this.key);return this.compare_hmacs(n.words,o.words)?r:""}},{key:"decrypt_payload",value:function(e){var t=JSON.parse(e);return JSON.parse(B.default.enc.Utf8.stringify(this.decrypt(t.ciphertext,t.iv,t.hmac)))}},{key:"compare_hmacs",value:function(e,t){for(var n=e.length===t.length,r=0;r<e.length;r++)e[r]!==t[r]&&(n=!1);return n}},{key:"sendMessage",value:function(e){if(this.connected&&!this.viewOnly){Kn.sends&&console.log(this.id,"Controller sending SEND ".concat(e.asState())),this.lastSent=Date.now();var t=e.asState(),n=k.default(t,3),r=n[0],o=n[1],i=n[2],a=JSON.stringify({msgPayload:i,viewId:this.viewId,lastSent:this.lastSent}),s=JSON.stringify(this.encrypt(a));this.connection.send(JSON.stringify({id:this.id,action:"SEND",args:[r,o,s,this.latency]}))}}},{key:"sendTagged",value:function(e,t){if(this.connected&&!this.viewOnly){Kn.sends&&console.log(this.id,"Controller sending tagged SEND ".concat(e.asState()," with tags ").concat(JSON.stringify(t))),this.lastSent=Date.now();var n=e.asState(),r=k.default(n,3),o=r[0],i=r[1],a=r[2],s=JSON.stringify({msgPayload:a,viewId:this.viewId,lastSent:this.lastSent}),u=JSON.stringify(this.encrypt(s));this.connection.send(JSON.stringify({id:this.id,action:"SEND",args:[o,i,u,this.latency],tags:t}))}}},{key:"sendTutti",value:function(e,t,n,r,o,i){if(this.connected&&!this.viewOnly){var a=A.default(n);Kn.sends&&console.log(this.id,"Controller sending TUTTI ".concat(a," ").concat(r&&r.asState()," ").concat(i)),this.tuttiHistory.push({tuttiSeq:t,payload:a}),this.tuttiHistory.length>100&&this.tuttiHistory.shift(),this.lastSent=Date.now(),this.connection.send(JSON.stringify({id:this.id,action:"TUTTI",args:[e,t,a,r&&r.asState(),o,i]}))}}},{key:"sendVote",value:function(e,t,n){var r=[this.island.id,"handleModelEventInView",this.island.id+":"+t];this.sendTutti(this.island.time,e,n,null,!0,r)}},{key:"addToStatistics",value:function(e,t){this.latency=t-e,this.latencyHistory&&(this.latencyHistory.length>=100&&this.latencyHistory.shift(),this.latencyHistory.push({time:t,ms:this.latency}))}},{key:"getTickAndMultiplier",value:function(){var e=this.islandCreator.options,t=(("tps"in e?e.tps:"tps"in this.islandCreator?this.islandCreator.tps:20)+"x").split("x").map((function(e){return Number.parseInt("0"+e,10)})),n=k.default(t,2),r=n[0],o=n[1],i=1e3/Math.max(1/30,Math.min(60,r)),a=Math.max(1,o),s=0;return a>1&&!Qn&&(this.tickMultiplier={tick:i,multiplier:a},s=Math.ceil(i*(a-1)/a)),{tick:i,multiplier:a,delay:s}}},{key:"requestTicks",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.connected&&this.island){var t=this.getTickAndMultiplier(),n=t.tick,r=t.delay;e.tick=n,e.delay=r,this.connection.setTick(n),Kn.session&&console.log(this.id,"Controller requesting TICKS",e);try{this.connection.send(JSON.stringify({id:this.id,action:"TICKS",args:e}))}catch(e){console.error("ERROR while sending",e)}}}},{key:"simulate",value:function(e){var t=this;if(!this.island)return!0;try{for(var n=ot.begin("simulate"),r=!0;r;){var o=this.networkQueue.peek();if(!o)break;if(!(r=this.island.advanceTo(o[0],e)))break;this.networkQueue.nextNonBlocking();var i=this.island.scheduleExternalMessage(o);r=this.island.advanceTo(i.time,e),this.cpuTime+=5}r&&(r=this.island.advanceTo(this.time,e)),this.cpuTime+=Math.max(.01,ot.end("simulate")-n);var a=this.backlog;if(ot.backlog(a),"boolean"==typeof this.synced&&(this.synced&&a>1e3||!this.synced&&a<100))!this.synced?this.syncTimer||(this.syncTimer=setTimeout((function(){delete t.syncTimer,t.backlog<100&&t.applySyncChange(!0)}),200)):this.applySyncChange(!1);return r&&this.cpuTime>5e3&&(this.triggeringCpuTime=this.cpuTime,this.cpuTime=0,setTimeout((function(){return t.scheduleSnapshot()}),Math.floor(2e3*Math.random()))),r}catch(e){return gt("simulate",e),this.connection.closeConnectionWithError("simulate",e),"error"}}},{key:"applySyncChange",value:function(e){this.synced=e,Tt.showSyncWait(!e),this.island.publishFromView(this.viewId,"synced",e)}},{key:"inViewRealm",value:function(e){var t=this;return $t(this.island,(function(){return e(t.island)}))}},{key:"processModelViewEvents",value:function(){return this.island?this.island.processModelViewEvents():0}},{key:"timeFromReflector",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"reflector";e<this.time?("controller"!==t||Kn.ticks)&&console.warn("time is ".concat(this.time,", ignoring time ").concat(e," from ").concat(t)):("boolean"!=typeof this.synced&&(this.synced=!1),this.time=e,this.island&&ot.backlog(this.backlog),this.tickHook&&this.tickHook())}},{key:"multiplyTick",value:function(e){var t=this;this.localTicker&&window.clearInterval(this.localTicker);var n=this.tickMultiplier,r=n.tick,o=n.multiplier,i=r/o,a=1;this.localTicker=window.setInterval((function(){t.timeFromReflector(e+a*i,"controller"),Kn.ticks&&console.log(t.id,"Controller generate TICK "+t.time,a),++a>=o&&(window.clearInterval(t.localTicker),t.localTicker=0)}),i)}},{key:"id",get:function(){return this.island?this.island.id:this.islandCreator.snapshot.id}},{key:"viewOnly",get:function(){return this.islandCreator.viewOnly}},{key:"backlog",get:function(){return this.island?this.time-this.island.time:0}},{key:"starvation",get:function(){return Date.now()-this.lastReceived}},{key:"activity",get:function(){return Date.now()-this.lastSent}},{key:"connected",get:function(){return this.connection.connected}},{key:"latencies",get:function(){return this.latencyHistory||(this.latencyHistory=[]),this.latencyHistory}}]),e}(),tr=function(){function e(t){S.default(this,e),this.controller=t,this.connectBlocked=!1,this.connectRestricted=!1,this.connectHasBeenCalled=!1,this.missingTickThreshold=1/0,this.setUpConnectionPromise()}var t;return x.default(e,[{key:"setTick",value:function(e){this.missingTickThreshold=Math.min(3*e,45e3)}},{key:"setUpConnectionPromise",value:function(){var e=this;this.connectionPromise=new Promise((function(t){return e.resolveConnection=t}))}},{key:"checkForConnection",value:function(e){this.socket||this.connectHasBeenCalled||this.connectBlocked||this.connectRestricted&&!e||this.connectToReflector()}},{key:"connectToReflector",value:(t=_.default(M.default.mark((function e(){var t,n=this;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.connectHasBeenCalled=!0,this.connectBlocked=!1,this.connectRestricted=!1,(t=Y.reflector||(Kn.reflector?"wss://croquet.io/reflector-dev/dev":Gn)).match(/^wss?:/)){e.next=6;break}throw Error("Cannot interpret reflector address "+t);case 6:return t.endsWith("/")||(t+="/"),e.abrupt("return",new Promise((function(e){var r=Object.assign(new WebSocket("".concat(t).concat(n.controller.id)),{onopen:function(t){n.socket=r,(Kn.session||Kn.reflector)&&console.log(n.socket.constructor.name,"connected to",n.socket.url),ot.connected(!0),n.resolveConnection(null),e()},onmessage:function(e){n.receive(e.data)},onerror:function(e){vt("Connection error"),console.log(r.constructor.name,"error")},onclose:function(e){var t=1e3!==e.code&&e.code<4100,o=4110===e.code;o||1e3===e.code||vt("Connection closed: ".concat(e.code," ").concat(e.reason),{duration:t?void 0:36e5}),Kn.session&&console.log(r.constructor.name,"closed:",e.code,e.reason),ot.connected(!1),o?n.connectRestricted=!0:n.connectBlocked=!0,n.disconnected(),t&&(yt("Reconnecting ..."),window.setTimeout((function(){return n.connectToReflector()}),2e3))}})})));case 8:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"disconnected",value:function(){this.socket&&(this.socket=null,this.lastReceived=0,this.lastSent=0,this.connectHasBeenCalled=!1,this.setUpConnectionPromise(),this.controller.leave())}},{key:"send",value:function(e){this.lastSent=Date.now(),this.socket.send(e)}},{key:"receive",value:function(e){this.lastReceived=Date.now();var t=JSON.parse(e),n=t.id,r=t.action,o=t.args;if(n)try{this.controller.receive(r,o)}catch(e){this.closeConnectionWithError("receive",e)}else switch(r){case"PONG":Kn.pong&&console.log("PONG after",Date.now()-o,"ms");break;default:console.warn("Unknown action",r)}}},{key:"dormantDisconnect",value:function(){this.connected&&(console.log("dormant; disconnecting from reflector"),this.socket.close(4110,"Going dormant"))}},{key:"closeConnectionWithError",value:function(e,t){console.error(t),console.warn("closing socket"),this.socket.close(4e3,"Error in "+e)}},{key:"PULSE",value:function(e){this.connected&&(0===this.socket.bufferedAmount?this.send(JSON.stringify({action:"PULSE"})):e-this.lastSent>500&&console.log("Reflector connection stalled: ".concat(this.socket.bufferedAmount," bytes unsent")))}},{key:"keepAlive",value:function(e){0!==this.lastReceived&&(e-this.lastSent>2e4||e-this.lastReceived>this.missingTickThreshold)&&this.PULSE(e)}},{key:"connected",get:function(){return this.socket&&this.socket.readyState===WebSocket.OPEN}}]),e}();window.setInterval((function(){var e,t=Hn(Zn);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.connected&&n.connection.keepAlive(Date.now())}}catch(e){t.e(e)}finally{t.f()}}),100);var nr=new(function(){function e(){S.default(this,e),this.ready=!1,this.isInIframe=window.top!==window,this.subscriptions={},this.enumerator=null}return x.default(e,[{key:"setReceiver",value:function(e){this.receiver=e,this.ready=!0}},{key:"setIframeEnumerator",value:function(e){this.enumerator=e}},{key:"on",value:function(e,t){var n=this;if(!this.receiver)throw Error("setReceiver() has not been called");if("string"==typeof t&&(t=this.receiver[t]),!t)throw Error("Messenger.on: the second argument must be a method name or a function");if(this.subscriptions[e]){if(this.findIndex(this.subscriptions[e],t)>=0)throw Error("".concat(t," is already subscribed"))}else this.subscriptions[e]=[];this.subscriptions[e].push(t),this.listener||(this.listener=function(e){return n.receive(e)},window.addEventListener("message",this.listener))}},{key:"detach",value:function(){this.listener&&(window.removeEventListener("message",this.listener),this.listener=null),this.stopPublishingPointerMove(),this.receiver=null,this.subscriptions={},this.enumerator=null,this.ready=!1}},{key:"removeSubscription",value:function(e,t){"string"==typeof t&&(t=this.receiver[t]);var n=this.subscriptions[e];if(n){var r=this.findIndex(n,t);n.splice(r,1),0===n.length&&delete this.subscriptions[e]}}},{key:"removeAllSubscriptions",value:function(){this.subscriptions={}}},{key:"receive",value:function(e){var t=e.data,n=t.event,r=t.data,o=e.source;this.handleEvent(n,r,o)}},{key:"handleEvent",value:function(e,t,n){var r=this,o=this.subscriptions[e];o&&o.forEach((function(e){e.call(r.receiver,t,n)}))}},{key:"send",value:function(e,t,n){this.isInIframe?window.top.postMessage({event:e,data:t},"*"):n?n.postMessage({event:e,data:t},"*"):this.enumerator&&this.enumerator().forEach((function(n){n.contentWindow.postMessage({event:e,data:t},"*")}))}},{key:"findIndex",value:function(e,t){return e.findIndex((function(e){return e.view===t.view&&e.method===t.method}))}},{key:"startPublishingPointerMove",value:function(){var e=this;this._moveHandler=function(t){return e.send("pointerPosition",{x:t.clientX,y:t.clientY,type:t.type})},window.document.addEventListener("pointermove",this._moveHandler,!0)}},{key:"stopPublishingPointerMove",value:function(){this._moveHandler&&(window.document.removeEventListener("pointermove",this._moveHandler,!0),this._moveHandler=null)}}]),e}());var rr={},or=function(){function e(){S.default(this,e)}var t,n;return x.default(e,null,[{key:"join",value:(n=_.default(M.default.mark((function t(n){var r,o,i,a,s,u,c,l,f,h,d,p,v,y,m,g,w,b,S,x,C,O,A,T,I,q,j,P,N,D=arguments;return M.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(N=function(){var e="autoSleep"in Y&&!Y.autoSleep,t="number"==typeof Y.autoSleep?1e3*Y.autoSleep:1e4,n=setInterval((function(){if(rr[g.id])if(C()){O||(O=Date.now(),A=w+O-b);var r=Date.now()-O;e?"manual"!==i.step&&g.step(A+r):r>t&&f.dormantDisconnect()}else O&&(O=0);else clearInterval(n)}),1e3)},P=function(e){return{modelRoot:r.create(e,"modelRoot")}},j=function(){g.model=null,g.view&&(Y.has("debug","session",!1)&&console.log(g.id,"Detaching root view"),g.view.detach(),""!==g.view.id&&console.warn("".concat(g.view," did not call super.detach()")),g.view=null),Tt.clearSessionMoniker(),nr.ready&&nr.detach()},q=function(){return(q=_.default(M.default.mark((function e(t){var r,a,s,u,c,d;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(j(),!f.leaving){e.next=4;break}return f.leaving(!0),e.abrupt("return");case 4:for(r={snapshot:t,init:P,destroyerFn:I,options:h},a=0,s=Object.entries(i);a<s.length;a++)u=k.default(s[a],2),c=u[0],d=u[1],l.includes(c)&&(r[c]=d);return e.next=8,f.establishSession(n,r);case 8:g.model=e.sent.modelRoot,g.id=f.id,rr[g.id]=f,Tt.makeSessionWidgets(g.id),f.inViewRealm((function(){Y.has("debug","session",!1)&&console.log(g.id,"Creating root view"),g.view=new o(g.model)}));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)},I=function(e){return q.apply(this,arguments)},a=function(e,t){return e===t||e.prototype instanceof t},r=D.length>1&&void 0!==D[1]?D[1]:mn,o=D.length>2&&void 0!==D[2]?D[2]:Cn,i=D.length>3?D[3]:void 0,"string"!=typeof n?n=JSON.stringify(n)||"undefined":n||(n="unnamed"),a(r,mn)){t.next=12;break}throw Error("ModelRoot must inherit from Croquet.Model");case 12:if(a(o,Cn)){t.next=19;break}if(!o||Object.getPrototypeOf(o)!==Object.prototype||void 0!==i){t.next=18;break}i=o,o=Cn,t.next=19;break;case 18:throw Error("ViewRoot must inherit from Croquet.View");case 19:i||(i={}),(s=Y.reflector||i.reflector)&&(s.includes("://")?Y.reflector=s:console.warn('Not a valid websocket url, ignoring reflector "'.concat(s,'"'))),i.debug&&(u=function(e){return"string"==typeof e&&(e=e.split(",")),e?Array.isArray(e)?e:[e]:[]},Y.debug=[].concat(E.default(u(i.debug)),E.default(u(Y.debug))).join(",")),"autoSleep"in i&&(Y.autoSleep=i.autoSleep),"expectedSimFPS"in i&&(sr=Math.min(i.expectedSimFPS,ar)),c=["tps"],l=["optionsFromUrl","login","autoSession"],lr(),f=new er,h={},i.options&&Object.assign(h,JSON.parse(JSON.stringify(i.options)));for(d=0,p=Object.entries(i);d<p.length;d++)v=k.default(p[d],2),y=v[0],m=v[1],c.includes(y)&&(h[y]=m);return t.t0=function(e){ur(e,f,g.view)},t.t1=function(){e.leave(g.id)},g={id:"",model:null,view:null,step:t.t0,leave:t.t1,get latency(){return f.latency},get latencies(){return f.latencies}},t.next=37,I();case 37:return w=0,b=Date.now(),S=0,x=1e3,C=function(){return"hidden"===document.visibilityState||Date.now()-b>x||S>x},O=0,A=0,T=function e(t){var n,r,o,a;rr[g.id]&&(n=S,r=t-w,o=.1,a=1e4,S=0|Math.min(a,Math.max(r,n*(1-o)+r*o)),w=t,b=Date.now(),C()||(f.checkForConnection(!0),"manual"!==i.step&&g.step(t)),window.requestAnimationFrame(e))},window.requestAnimationFrame(T),N(),t.abrupt("return",g);case 48:case"end":return t.stop()}}),t)}))),function(e){return n.apply(this,arguments)})},{key:"leave",value:(t=_.default(M.default.mark((function e(t){var n,r,o;return M.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=rr[t]){e.next=3;break}return e.abrupt("return",!1);case 3:if(delete rr[t],r=new Promise((function(e){return n.leaving=e})),(o=n.connection).connected){e.next=8;break}return e.abrupt("return",!1);case 8:return o.socket.close(1e3),e.abrupt("return",r);case 10:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"thisSession",value:function(){var e=Yt.current();return e?e.id:""}}]),e}(),ir=[0],ar=120,sr=60;function ur(e,t,n){var r=t.backlog,o=t.latency,i=t.starvation,a=t.activity;if(ot.animationFrame(e,{backlog:r,starvation:i,latency:o,activity:a,users:t.users}),t.island){var s=Date.now(),u=ir.reduce((function(e,t){return e+t}),0)/ir.length;t.simulate(s+Math.min(u,200));var c=0===sr?0:1e3/sr*4;t.backlog>c&&t.simulate(s+200-u),ir.push(Date.now()-s),ir.length>4&&ir.shift(),ot.begin("update"),t.processModelViewEvents(),ot.end("update"),n&&(ot.begin("render"),t.inViewRealm((function(){return n.update(e)})),ot.end("render"))}}var cr={};function lr(){Object.isFrozen(cr)||(function e(t){if(!Object.isFrozen(t)){Object.freeze(t);for(var n=0,r=Object.values(t);n<r.length;n++){var o=r[n];!o||"object"!==C.default(o)&&"function"!=typeof o||e(o)}}}(cr),function(e){var t=JSON.stringify(e,(function(e,t){return"function"==typeof t?""+t:t}));if("{}"!==t){var n=JSON.parse(t),r=be(A.default(n));r.then((function(e){console.log("hashing Croquet.Constants(".concat(Object.keys(n).join(", "),"): ").concat(e)),ve()&&(ye[e].name="Croquet Constants")})),Ce.push(r)}}(cr))}exports.App=Tt,exports.Constants=cr,exports.Data=Fn,exports.Messenger=nr,exports.Model=mn,exports.Session=or,exports.View=Cn,exports.gatherInternalClassTypes=function(e,t){var n={};return function e(t){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Set,a=Object.values(t).filter((function(e){var t=Object.prototype.toString.call(e).slice(8,-1);return("Object"===t||"Array"===t)&&!i.has(e)})),s=zt(a);try{for(s.s();!(n=s.n()).done;){var u=n.value;i.add(u);var c=r+"."+u.constructor.name;if(o[c]){if(o[c]!==u.constructor)throw new Error("Class with name "+c+" already gathered, but new one has different identity")}else o[c]=u.constructor}}catch(e){s.e(e)}finally{s.f()}var l,f=zt(a);try{for(f.s();!(l=f.n()).done;){e(l.value,r,o,i)}}catch(e){f.e(e)}finally{f.f()}}({root:e},t,n,new Set),n},exports.startSession=function(){return Tt.showMessage("Croquet.startSession() is deprecated, please use Croquet.Session.join()",{level:"warning",only:"once"}),or.join.apply(or,arguments)};
