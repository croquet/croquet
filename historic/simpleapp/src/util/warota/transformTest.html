<html>
<head>
<script type="module">
import {Doc, Event} from "./warota.mjs";

window.onload = function () {
    let timezone;
    let user1 ={id: '010203', color: '010203'};
    let user2 ={id: '020406', color : '020406'};

    let doc;
    let content;

    function resetContent() {
        content = {runs:
                   [{text: "man is much more than a tool builder."}],
                   selections: {}, timezone: 0, queue: [],
                   undoStacks: {}
                  };
        window.content = content;
        doc = new Doc();
        window.doc = doc;
        doc.load(content.runs);
    }

    function doIt(doc, edit) {
        timezone = doc.receiveEditEvents([edit], content, doc);
    }

    function case1() {
        resetContent();

        let edit1 = Event.select(user1, 1, 1, content.timezone);

        let edit2 = Event.select(user2, 2, 3, content.timezone);
        doIt(doc, edit1);
        doIt(doc, edit2);

        let edit3 = Event.insert(user1, [{text: 'A'}], content.timezone);
        doIt(doc, edit3);

        let edit4 = Event.insert(user2, [{text: 'B'}], content.timezone);
        doIt(doc, edit4);
   }

   case1.expected = "mAaB is much more than a tool builder.";

   function case2() {
        resetContent();

        let edit1 = Event.select(user1, 1, 1, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 3, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.insert(user2, [{text: 'B'}], content.timezone);
        doIt(doc, edit3);

        let edit4 = Event.insert(user1, [{text: 'A'}], content.timezone);
        doIt(doc, edit4);
   }

   case2.expected = "mAaB is much more than a tool builder.";

   function case3() {
        resetContent();

        let edit1 = Event.select(user1, 1, 2, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 2, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.insert(user2, [{text: 'B'}], content.timezone);
        doIt(doc, edit3);

        let edit4 = Event.insert(user1, [{text: 'A'}], content.timezone);
        doIt(doc, edit4);
   }

   case3.expected = "mABn is much more than a tool builder.";

   function case4() {
        resetContent();

        let edit1 = Event.select(user1, 1, 2, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 2, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.insert(user1, [{text: 'A'}], content.timezone);
        doIt(doc, edit3);

        let edit4 = Event.insert(user2, [{text: 'B'}], content.timezone);
        doIt(doc, edit4);
   }

   case4.expected = "mABn is much more than a tool builder.";


//   console.log("case4:", window.doc.runs[0], window.doc.runs[0].text === );

   function case5() {
        resetContent();

        let edit1 = Event.select(user1, 1, 2, content.timezone);
        let edit2 = Event.select(user2, 1, 1, content.timezone);
        let edit3 = Event.insert(user1, [{text: 'A'}], content.timezone);
        let edit4 = Event.insert(user2, [{text: 'B'}], content.timezone);

        doIt(doc, edit1);
        doIt(doc, edit2);
        doIt(doc, edit3);
        doIt(doc, edit4);
   }

   case5.expected = "mABn is much more than a tool builder.";

   function case6() {
        resetContent();

        let edit1 = Event.select(user1, 1, 1, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.insert(user1, [{text: 'A'}], content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.insert(user1, [{text: 'B'}], content.timezone);
        doIt(doc, edit3);
   }

   case6.expected = "mABan is much more than a tool builder.";

   function case7() {
        resetContent();

        let edit1 = Event.select(user1, 0, 0, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.insert(user1, [{text: 'A'}], content.timezone);
        doIt(doc, edit2);

   }

   case7.expected = "Aman is much more than a tool builder.";

   function case8() {
        resetContent();

        let edit1 = Event.select(user1, 1, 4, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 3, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.delete(user2, true, content.timezone);
        doIt(doc, edit3);
   }

   case8.expected = "ma is much more than a tool builder.";
   case8.selections = {[user1.id]: {start: 1, end: 3}, [user2.id]: {start: 2, end: 2}};

   function case9() {
        resetContent();

        let edit1 = Event.select(user1, 1, 3, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 4, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.delete(user1, true, content.timezone);
        doIt(doc, edit3);
   }

   case9.expected = "m is much more than a tool builder.";
   case9.selections = {[user1.id]: {start: 1, end: 1}, [user2.id]: {start: 1, end: 2}};

   function case10() {
        resetContent();

        let edit1 = Event.select(user1, 1, 3, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 4, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.delete(user2, true, content.timezone);
        doIt(doc, edit3);
   }

   case10.expected = "mais much more than a tool builder.";
   case10.selections = {[user1.id]: {start: 1, end: 2}, [user2.id]: {start: 2, end: 2}};

   function case11() {
        resetContent();

        let edit1 = Event.select(user1, 1, 4, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 3, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.delete(user1, true, content.timezone);
        doIt(doc, edit3);
   }

   case11.expected = "mis much more than a tool builder.";
   case11.selections = {[user1.id]: {start: 1, end: 1}, [user2.id]: {start: 1, end: 1}};

   function case12() {
        resetContent();

        let edit1 = Event.select(user1, 1, 4, content.timezone);
        doIt(doc, edit1);

        let edit2 = Event.select(user2, 2, 4, content.timezone);
        doIt(doc, edit2);

        let edit3 = Event.delete(user1, true, content.timezone);
        doIt(doc, edit3);
   }

   case12.expected = "mis much more than a tool builder.";
   case12.selections = {[user1.id]: {start: 1, end: 1}, [user2.id]: {start: 1, end: 1}};

   //let run = [case1, case2, case3, case4, case5, case6, case7, case8];
   let run = [case12];
   run.forEach(r => {
     r();
     console.log(r.name + ":", window.doc.runs[0], window.doc.runs[0].text === r.expected);
     let result = true;
     if (!r.selections) {return;}
     for (let k in r.selections) {
       result = result && (r.selections[k].start === content.selections[k].start);
       result = result && (r.selections[k].end === content.selections[k].end);
     }
     console.log('selections:', content.selections, result);
   });
}
</script>

</head>
<body>
</body>
</html>
