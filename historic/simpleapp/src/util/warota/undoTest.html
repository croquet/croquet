<html>
<head>
<script type="module">
import {Doc, Event} from "./warota.mjs";

window.onload = function () {
    let timezone;
    let user1 ={id: '010203', color: '010203'};
    let user2 ={id: '020406', color : '020406'};

    let doc;
    let content;

    function resetContent() {
        content = {runs:
                   [{text: "man is much more than a tool builder."}],
                   selections: {}, timezone: 0, queue: [],
                   undoStacks: {}
                  };
        window.content = content;
        doc = new Doc();
        window.doc = doc;
        doc.load(content.runs);
    }

    function doIt(doc, edit) {
        timezone = doc.receiveEditEvents([edit], content, doc);
    }

    function undoIt(user) {
        let event;
        let queue = content.queue;
        for (let i = queue.length - 1; i >= 0; i--) {
            if (queue[i].user.id === user.id && queue[i].type !== "snapshot") {
                event = queue[i];
                break;
            }
        }
        if (!event) {return;}

        doc.undoEvent(event, content, doc);
    }


   function case1() {
        resetContent();

        let edit1 = Event.select(user1, 1, 1, user1, content.timezone);
        doIt(doc, edit1);
        for (let i = 0; i < 20; i++) {
          let edit2 = Event.insert(user1, [{text: String.fromCharCode(65+i)}], content.timezone);
          doIt(doc, edit2);
        }

        undoIt(user1);

        let edit4 = Event.insert(user1, [{text: 'C'}], content.timezone);
        doIt(doc, edit4);
   }

   case1.expected = "mABCDEFGHIJKLMNOPQRSCan is much more than a tool builder.";

   function case2() {
        resetContent();

        let edit1 = Event.select(user1, 1, 1, user1, content.timezone);
        let edit2 = Event.select(user2, 1, 1, user1, content.timezone);
        doIt(doc, edit1);
        doIt(doc, edit2);

        for (let i = 0; i < 10; i++) {
          let edit3 = Event.insert(user1, [{text: String.fromCharCode(65+i)}], content.timezone);
          doIt(doc, edit3);
        }

        for (let i = 0; i < 10; i++) {
          let edit3 = Event.insert(user2, [{text: String.fromCharCode(48+i)}], content.timezone);
          doIt(doc, edit3);
        }

        undoIt(user1);
        undoIt(user2);
        undoIt(user1);

        let edit4 = Event.insert(user1, [{text: 'Z'}], content.timezone);
        doIt(doc, edit4);
   }

   case2.expected = "mABCDEFGH012345678Zan is much more than a tool builder.";

   //let run = [case1, case2, case3, case4, case5, case6, case7, case1, case2];
   let run = [case2];
   run.forEach(r => {
     r();
     console.log(r.name + ":", window.doc.runs[0], window.doc.runs[0].text === r.expected);
   });
}
</script>

</head>
<body>
</body>
</html>
