<html>
    <head>
        <meta charset="utf-8">
        <title>Data test</title>
        <script src="https://cdn.jsdelivr.net/npm/@croquet/croquet@1.0.5"></script>
    </head>
    <body style="background-color: #666; background-size: contain; background-repeat: no-repeat; background-position: center;" onclick="imageinput.click()">
        <input id="imageinput" type="file" accept="image/*" style="display:none;">
        <span id="message" style="background-color: rgb(255,255,255,0.5);">click to import picture, or drag-and-drop one</i></span>
        <script>


class DataTestModel extends Croquet.Model {

    init() {
        this.subscribe("global", "add-asset", this.addAsset);
    }

    addAsset(asset) {
        this.asset = asset;
        this.publish("global", "asset-added", asset);
    }

}
DataTestModel.register("DataTestModel");


class DataTestView extends Croquet.View {

    constructor(model) {
        super(model);
        this.subscribe("global", "asset-added", this.assetAdded);
        if (model.asset) this.assetAdded(model.asset);

        window.ondragover = event => event.preventDefault();
        window.ondrop = event => {
            event.preventDefault();
            this.addFile(event.dataTransfer.items[0].getAsFile());
        }
        imageinput.onchange = () => {
            this.addFile(imageinput.files[0]);
            imageinput.value = ''; // otherwise upload of another camera images won't trigger onchange
        };
    }

    // only uploading user does this
    async addFile(file) {
        if (!file.type.startsWith('image/')) return this.showMessage(`Not an image: "${file.name}" (${file.type})`);
        this.showMessage(`reading "${file.name}" (${file.type})`);
        const data = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsArrayBuffer(file);
        });
        this.showMessage(`sending "${file.name}" (${data.byteLength} bytes}`);
        const handle = await Croquet.Data.store(this.sessionId, data); // <== Croquet.Data API
        const asset = { name: file.name, type: file.type, size: data.byteLength, handle };
        this.publish("global", "add-asset", asset);
    }

    // every user gets this event via model
    async assetAdded(asset) {
        this.showMessage(`fetching "${asset.name}" (${asset.size} bytes}`);
        this.showImage(asset);
    }

    showMessage(string) {
        message.innerText = string;
        console.log(string);
    }

    async showImage(asset) {
        const data = await Croquet.Data.fetch(this.sessionId, asset.handle);  // <== Croquet.Data API
        this.showMessage(`fetched "${asset.name}" (${data.byteLength} bytes)`);
        const blob = new Blob([data], { type: asset.type });
        document.body.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
    }
}


Croquet.App.makeWidgetDock();
Croquet.Session.join({
    appId: "com.example.datatest", // replace with your own!
    apiKey: '2DT9VCoCKtvXMKkBGZXNLrUEoZMn48ojXPC8XFAuuO',
    name: Croquet.App.autoSession(),
    password: Croquet.App.autoPassword(),
    model: DataTestModel,
    view: DataTestView,
    tps: 0,
});


        </script>
    </body>
</html>
